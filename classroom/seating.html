<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šåº§ä½ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.05);
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            position: relative;
        }

        .header .back-home {
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            text-decoration: none;
            font-size: 1rem;
            transition: opacity 0.3s;
        }

        .header .back-home:hover {
            opacity: 0.7;
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .content {
            padding: 24px;
        }

        .step-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 16px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .step-btn {
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .step-btn:hover {
            border-color: #2563eb;
            color: #2563eb;
        }

        .step-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .step-btn.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .section {
            display: none;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            background: #fafafa;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            margin: 4px;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-success {
            background: #16a34a;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.75rem;
        }

        .classroom-grid {
            display: grid;
            gap: 8px;
            justify-content: center;
            margin: 24px 0;
            padding: 24px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .seat {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: 500;
            border: 2px solid transparent;
            position: relative;
            padding: 2px;
        }

        .seat.available {
            background: #dcfce7;
            color: #166534;
            border-color: #22c55e;
        }

        .seat.unavailable {
            background: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }

        .seat.occupied {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .seat.assigned {
            background: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }

        .seat:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .teacher-desk {
            background: #10b981;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            margin: 16px auto 0;
            width: 100px;
            height: 40px;
            font-size: 0.875rem;
        }

        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .student-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .student-item:hover {
            border-color: #2563eb;
            background: #f1f5f9;
        }

        .student-item.assigned {
            background: #ecfdf5;
            border-color: #22c55e;
        }

        .controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 12px;
            top: 12px;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
        }

        .close:hover {
            color: #374151;
        }

        .classroom-selector {
            margin-bottom: 24px;
        }

        .classroom-card {
            background: white;
            padding: 16px;
            margin: 8px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 180px;
            position: relative;
        }

        .classroom-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .classroom-card.active {
            border-color: #2563eb;
            background: #f0f9ff;
        }

        .classroom-card h3 {
            margin-bottom: 4px;
            font-size: 1rem;
            font-weight: 600;
        }

        .classroom-card p {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #b91c1c;
        }

        .remaining-students {
            background: #fef3c7;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border-left: 4px solid #f59e0b;
        }

        .status-legend {
            display: flex;
            gap: 16px;
            margin: 16px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }

        .back-to-selector {
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .seat {
                width: 50px;
                height: 50px;
                font-size: 9px;
            }
            
            .classroom-grid {
                gap: 6px;
                padding: 16px;
            }
            
            .step-nav {
                flex-direction: column;
                align-items: center;
            }
            
            .step-btn {
                min-width: 100px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 0.875rem;
        }

        .alert-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fed7aa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../index.html" class="back-home">â† è¿”å›é¦–é </a>
            <h1>ğŸ“š ç­ç´šåº§ä½ç³»çµ±</h1>
            <p>æ™ºèƒ½åº§ä½ç®¡ç†ï¼Œè®“ç­ç´šç®¡ç†æ›´è¼•é¬†</p>
        </div>

        <div class="content">
            <!-- è¿”å›ç­ç´šé¸æ“‡æŒ‰éˆ• -->
            <div class="back-to-selector" id="backToSelector" style="display: none;">
                <button class="btn btn-secondary" onclick="showClassroomSelector()">â† è¿”å›ç­ç´šé¸æ“‡</button>
            </div>

            <!-- æ­¥é©Ÿå°èˆª -->
            <div class="step-nav" id="stepNav" style="display: none;">
                <button class="step-btn" onclick="goToStep(1)" id="stepBtn1">1. ç­ç´šè³‡è¨Š</button>
                <button class="step-btn" onclick="goToStep(2)" id="stepBtn2">2. å­¸ç”Ÿæ¸…å–®</button>
                <button class="step-btn" onclick="goToStep(3)" id="stepBtn3">3. æ•™å®¤é…ç½®</button>
                <button class="step-btn" onclick="goToStep(4)" id="stepBtn4">4. åº§ä½ç®¡ç†</button>
                <button class="step-btn" onclick="goToStep(5)" id="stepBtn5">5. åº§ä½åˆ†é…</button>
            </div>

            <!-- ç­ç´šé¸æ“‡ -->
            <div class="classroom-selector" id="classroomSelector">
                <div class="section active">
                    <h2>ğŸ« é¸æ“‡ç­ç´šæˆ–å‰µå»ºæ–°ç­ç´š</h2>
                    <div id="classroomList"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="showCreateClassModal()">+ å‰µå»ºæ–°ç­ç´š</button>
                    </div>
                </div>
            </div>

            <!-- æ­¥é©Ÿ1: ç­ç´šè³‡è¨Š -->
            <div class="section" id="section1">
                <h2>ğŸ“ æ­¥é©Ÿ1: ç­ç´šè³‡è¨Š</h2>
                <div class="form-group">
                    <label for="className">æ•™å®¤åç¨±ï¼š</label>
                    <input type="text" id="className" placeholder="ä¾‹å¦‚ï¼šäº”å¹´ä¸€ç­" readonly>
                </div>
                <p style="color: #6b7280; font-size: 0.875rem;">ç­ç´šè³‡è¨Šå·²è¨­å®šå®Œæˆï¼Œå¯ç›´æ¥é€²å…¥ä¸‹ä¸€æ­¥é©Ÿã€‚</p>
            </div>

            <!-- æ­¥é©Ÿ2: åŠ å…¥å­¸ç”Ÿæ¸…å–® -->
            <div class="section" id="section2">
                <h2>ğŸ‘¥ æ­¥é©Ÿ2: å­¸ç”Ÿæ¸…å–®</h2>
                <div class="form-group">
                    <label for="studentList">å­¸ç”Ÿæ¸…å–®ï¼ˆæ¯è¡Œä¸€å€‹å­¸ç”Ÿï¼Œæ ¼å¼ï¼šåº§è™Ÿ å§“åï¼‰ï¼š</label>
                    <textarea id="studentList" rows="8" placeholder="ä¾‹å¦‚ï¼š&#10;1 ç‹å°æ˜&#10;2 æå°è¯&#10;3 å¼µå°ç¾"></textarea>
                </div>
                <button class="btn" onclick="addStudents()">æ›´æ–°å­¸ç”Ÿæ¸…å–®</button>
                <div class="student-list" id="currentStudents"></div>
            </div>

            <!-- æ­¥é©Ÿ3: ç”¢ç”Ÿè¡Œåˆ—æ•¸é‡ -->
            <div class="section" id="section3">
                <h2>ğŸ« æ­¥é©Ÿ3: æ•™å®¤é…ç½®</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="rows">è¡Œæ•¸ï¼š</label>
                        <input type="number" id="rows" min="1" max="10" value="4">
                    </div>
                    <div class="form-group">
                        <label for="cols">åˆ—æ•¸ï¼š</label>
                        <input type="number" id="cols" min="1" max="10" value="6">
                    </div>
                </div>
                <button class="btn" onclick="generateSeating()">æ›´æ–°åº§ä½é…ç½®</button>
                <div id="classroomDisplay"></div>
            </div>

            <!-- æ­¥é©Ÿ4: åº§ä½ç®¡ç† -->
            <div class="section" id="section4">
                <h2>ğŸª‘ æ­¥é©Ÿ4: åº§ä½ç‹€æ…‹ç®¡ç†</h2>
                <p style="margin-bottom: 16px;">é»æ“Šåº§ä½å¯ä»¥åˆ‡æ›ç‹€æ…‹ï¼š</p>
                <div class="status-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dcfce7; border-color: #22c55e;"></div>
                        <span>å¯ç”¨åº§ä½</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fee2e2; border-color: #ef4444;"></div>
                        <span>é—œé–‰åº§ä½</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fef3c7; border-color: #f59e0b;"></div>
                        <span>å·²è¢«ä½”é ˜</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-success" onclick="setAllSeats('available')">å…¨éƒ¨é–‹å•Ÿ</button>
                    <button class="btn btn-danger" onclick="setAllSeats('unavailable')">å…¨éƒ¨é—œé–‰</button>
                </div>
                <div id="seatManagement"></div>
            </div>

            <!-- æ­¥é©Ÿ5: éš¨æ©Ÿåº§ä½ -->
            <div class="section" id="section5">
                <h2>ğŸ² æ­¥é©Ÿ5: åº§ä½åˆ†é…</h2>
                <div class="status-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dbeafe; border-color: #3b82f6;"></div>
                        <span>å·²åˆ†é…åº§ä½</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn" onclick="randomAssignSeats()">éš¨æ©Ÿåˆ†é…åº§ä½</button>
                    <button class="btn btn-secondary" onclick="clearAssignments()">æ¸…é™¤åˆ†é…</button>
                    <button class="btn btn-success" onclick="saveArrangement()">ä¸‹è¼‰åº§ä½è¡¨</button>
                </div>
                <div class="remaining-students" id="remainingStudents"></div>
                <div id="finalSeating"></div>
            </div>
        </div>
    </div>

    <!-- å‰µå»ºç­ç´šæ¨¡æ…‹æ¡† -->
    <div id="createClassModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateClassModal()">&times;</span>
            <h2 style="margin-bottom: 16px;">å‰µå»ºæ–°ç­ç´š</h2>
            <div class="form-group">
                <label for="newClassName">æ•™å®¤åç¨±ï¼š</label>
                <input type="text" id="newClassName" placeholder="ä¾‹å¦‚ï¼šäº”å¹´ä¸€ç­">
            </div>
            <button class="btn" onclick="createNewClassroom()">å‰µå»º</button>
        </div>
    </div>

    <!-- é¸æ“‡å­¸ç”Ÿæ¨¡æ…‹æ¡† -->
    <div id="selectStudentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSelectStudentModal()">&times;</span>
            <h2 style="margin-bottom: 16px;">é¸æ“‡ä½”é ˜åº§ä½çš„å­¸ç”Ÿ</h2>
            <div id="availableStudents"></div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let classrooms = {};
        let currentClassroom = null;
        let currentStep = 1;
        let selectedSeatForOccupation = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadClassrooms();
            showClassroomSelector();
        });

        // å„²å­˜èˆ‡è¼‰å…¥è³‡æ–™ - ä½¿ç”¨æœ¬åœ°å„²å­˜
        function saveToStorage() {
            const data = {
                classrooms: classrooms,
                currentClassroom: currentClassroom,
                lastUpdated: new Date().toISOString()
            };
            
            try {
                // ä½¿ç”¨æœ¬åœ°å„²å­˜çš„æ›¿ä»£æ–¹æ¡ˆ
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem('classroomData', JSON.stringify(data));
                } else {
                    // å¦‚æœä¸æ”¯æ´localStorageï¼Œä½¿ç”¨è¨˜æ†¶é«”å„²å­˜
                    window.classroomDataBackup = data;
                }
            } catch (e) {
                // å®¹éŒ¯è™•ç†ï¼Œä½¿ç”¨è¨˜æ†¶é«”å„²å­˜
                window.classroomDataBackup = data;
            }
        }

        function loadClassrooms() {
            try {
                let data = null;
                
                // å˜—è©¦å¾localStorageè¼‰å…¥
                if (typeof(Storage) !== "undefined") {
                    const stored = localStorage.getItem('classroomData');
                    if (stored) {
                        data = JSON.parse(stored);
                    }
                }
                
                // å¦‚æœlocalStorageå¤±æ•—ï¼Œå˜—è©¦å¾è¨˜æ†¶é«”è¼‰å…¥
                if (!data && window.classroomDataBackup) {
                    data = window.classroomDataBackup;
                }
                
                // è¼‰å…¥è³‡æ–™
                if (data) {
                    classrooms = data.classrooms || {};
                    currentClassroom = data.currentClassroom;
                }
                
            } catch (e) {
                console.log('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨é è¨­è¨­å®š');
                classrooms = {};
                currentClassroom = null;
            }
            
            updateClassroomList();
        }

        function showClassroomSelector() {
            // éš±è—æ‰€æœ‰æ­¥é©Ÿå€å¡Š
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`section${i}`).classList.remove('active');
            }
            document.getElementById('classroomSelector').style.display = 'block';
            document.getElementById('stepNav').style.display = 'none';
            document.getElementById('backToSelector').style.display = 'none';
            currentClassroom = null;
        }

        function updateClassroomList() {
            const listElement = document.getElementById('classroomList');
            listElement.innerHTML = '';
            
            if (Object.keys(classrooms).length === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: #6b7280; margin: 20px 0;">å°šæœªå‰µå»ºä»»ä½•ç­ç´š</p>';
                return;
            }
            
            Object.keys(classrooms).forEach(className => {
                const card = document.createElement('div');
                card.className = 'classroom-card';
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteClassroom('${className}')" title="åˆªé™¤ç­ç´š">Ã—</button>
                    <h3>${className}</h3>
                    <p>å­¸ç”Ÿæ•¸: ${classrooms[className].students ? classrooms[className].students.length : 0}</p>
                `;
                card.onclick = (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                        selectClassroom(className);
                    }
                };
                listElement.appendChild(card);
            });
        }

        function showCreateClassModal() {
            document.getElementById('createClassModal').style.display = 'block';
        }

        function closeCreateClassModal() {
            document.getElementById('createClassModal').style.display = 'none';
            document.getElementById('newClassName').value = '';
        }

        function createNewClassroom() {
            const className = document.getElementById('newClassName').value.trim();
            if (!className) {
                alert('è«‹è¼¸å…¥æ•™å®¤åç¨±');
                return;
            }
            
            if (classrooms[className]) {
                alert('ç­ç´šå·²å­˜åœ¨');
                return;
            }

            classrooms[className] = {
                students: [],
                rows: 4,
                cols: 6,
                seats: {},
                assignments: {}
            };
            
            saveToStorage();
            closeCreateClassModal();
            updateClassroomList();
            selectClassroom(className);
        }

        function selectClassroom(className) {
            currentClassroom = className;
            saveToStorage();
            
            document.getElementById('classroomSelector').style.display = 'none';
            document.getElementById('stepNav').style.display = 'flex';
            document.getElementById('backToSelector').style.display = 'block';
            
            // æª¢æŸ¥ç­ç´šå®Œæˆåº¦ä¸¦è·³åˆ°é©ç•¶æ­¥é©Ÿ
            const classroom = classrooms[className];
            if (!classroom.students || classroom.students.length === 0) {
                goToStep(2);
            } else if (!classroom.seats || Object.keys(classroom.seats).length === 0) {
                goToStep(3);
            } else {
                goToStep(4);
            }
        }

        function deleteClassroom(className) {
            event.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶å…ƒç´ é»æ“Šäº‹ä»¶
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç­ç´šã€Œ${className}ã€å—ï¼Ÿ`)) {
                delete classrooms[className];
                if (currentClassroom === className) {
                    currentClassroom = null;
                }
                saveToStorage();
                updateClassroomList();
            }
        }

        function goToStep(step) {
            if (!currentClassroom) {
                showClassroomSelector();
                return;
            }
            
            currentStep = step;
            
            // éš±è—æ‰€æœ‰å€å¡Š
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`section${i}`).classList.remove('active');
            }
            
            // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿ
            document.getElementById(`section${step}`).classList.add('active');
            updateStepNavigation();
            
            // è¼‰å…¥ç•¶å‰ç­ç´šè³‡æ–™
            loadCurrentClassroomData();
        }

        function updateStepNavigation() {
            const classroom = classrooms[currentClassroom];
            
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`stepBtn${i}`);
                btn.className = 'step-btn';
                
                // åˆ¤æ–·æ­¥é©Ÿå®Œæˆç‹€æ…‹
                let isCompleted = false;
                if (i === 1) isCompleted = true; // ç­ç´šè³‡è¨Šç¸½æ˜¯å®Œæˆçš„
                if (i === 2) isCompleted = classroom.students && classroom.students.length > 0;
                if (i === 3) isCompleted = classroom.seats && Object.keys(classroom.seats).length > 0;
                if (i === 4) isCompleted = classroom.seats && Object.keys(classroom.seats).length > 0;
                if (i === 5) isCompleted = classroom.seats && Object.keys(classroom.seats).length > 0;
                
                if (i === currentStep) {
                    btn.classList.add('active');
                } else if (isCompleted && i < currentStep) {
                    btn.classList.add('completed');
                }
            }
        }

        function loadCurrentClassroomData() {
            if (!currentClassroom || !classrooms[currentClassroom]) return;
            
            const classroom = classrooms[currentClassroom];
            
            // è¼‰å…¥ç­ç´šåç¨±
            document.getElementById('className').value = currentClassroom;
            
            // è¼‰å…¥å­¸ç”Ÿæ¸…å–®
            if (classroom.students) {
                const studentListText = classroom.students.map(s => `${s.id} ${s.name}`).join('\n');
                document.getElementById('studentList').value = studentListText;
                updateCurrentStudentsList();
            }
            
            // è¼‰å…¥åº§ä½é…ç½®
            if (classroom.rows && classroom.cols) {
                document.getElementById('rows').value = classroom.rows;
                document.getElementById('cols').value = classroom.cols;
                generateSeatingDisplay();
            }
            
            updateRemainingStudents();
        }

        function addStudents() {
            const studentListText = document.getElementById('studentList').value.trim();
            if (!studentListText) {
                alert('è«‹è¼¸å…¥å­¸ç”Ÿæ¸…å–®');
                return;
            }
            
            const students = [];
            const lines = studentListText.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (line) {
                    const parts = line.split(/\s+/);
                    if (parts.length >= 2) {
                        const id = parts[0];
                        const name = parts.slice(1).join(' ');
                        students.push({ id, name, assigned: false });
                    }
                }
            }
            
            if (students.length === 0) {
                alert('è«‹ç¢ºèªå­¸ç”Ÿæ¸…å–®æ ¼å¼æ­£ç¢º');
                return;
            }
            
            classrooms[currentClassroom].students = students;
            
            // æ¸…é™¤åº§ä½åˆ†é…ï¼Œå› ç‚ºå­¸ç”Ÿæ¸…å–®æ”¹è®Šäº†
            const classroom = classrooms[currentClassroom];
            if (classroom.seats) {
                Object.keys(classroom.seats).forEach(seatId => {
                    classroom.seats[seatId].assignedStudent = null;
                });
            }
            
            saveToStorage();
            updateCurrentStudentsList();
            updateStepNavigation();
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success';
            alertDiv.textContent = `å·²æˆåŠŸåŠ å…¥ ${students.length} ä½å­¸ç”Ÿ`;
            document.getElementById('section2').appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function updateCurrentStudentsList() {
            const container = document.getElementById('currentStudents');
            if (!currentClassroom || !classrooms[currentClassroom].students) {
                container.innerHTML = '';
                return;
            }
            
            const students = classrooms[currentClassroom].students;
            
            if (students.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; margin-top: 16px;">å°šæœªåŠ å…¥ä»»ä½•å­¸ç”Ÿ</p>';
                return;
            }
            
            container.innerHTML = `<h3 style="margin-top: 20px; margin-bottom: 12px;">ç•¶å‰å­¸ç”Ÿæ¸…å–® (${students.length}äºº)ï¼š</h3>`;
            const studentGrid = document.createElement('div');
            studentGrid.className = 'student-list';
            
            students.forEach(student => {
                const div = document.createElement('div');
                div.className = `student-item ${student.assigned ? 'assigned' : ''}`;
                div.innerHTML = `
                    <strong>${student.id}</strong> ${student.name}
                    ${student.assigned ? '<br><small style="color: #16a34a;">âœ“ å·²åˆ†é…åº§ä½</small>' : ''}
                `;
                studentGrid.appendChild(div);
            });
            
            container.appendChild(studentGrid);
        }

        function generateSeating() {
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            
            if (rows < 1 || cols < 1) {
                alert('è¡Œåˆ—æ•¸å¿…é ˆå¤§æ–¼0');
                return;
            }
            
            classrooms[currentClassroom].rows = rows;
            classrooms[currentClassroom].cols = cols;
            classrooms[currentClassroom].seats = {};
            
            // åˆå§‹åŒ–æ‰€æœ‰åº§ä½ç‚ºå¯ç”¨
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const seatId = `${r}-${c}`;
                    classrooms[currentClassroom].seats[seatId] = {
                        row: r,
                        col: c,
                        status: 'available', // available, unavailable, occupied
                        occupiedBy: null,
                        assignedStudent: null
                    };
                }
            }
            
            saveToStorage();
            generateSeatingDisplay();
            updateStepNavigation();
        }

        function generateSeatingDisplay() {
            const classroom = classrooms[currentClassroom];
            if (!classroom || !classroom.seats) return;
            
            const containers = ['classroomDisplay', 'seatManagement', 'finalSeating'];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '<div class="classroom-grid" id="seatingGrid_' + containerId + '"></div><div class="teacher-desk">æ•™å¸«è¬›æ¡Œ</div>';
                
                const grid = document.getElementById('seatingGrid_' + containerId);
                grid.style.gridTemplateColumns = `repeat(${classroom.cols}, 60px)`;
                grid.style.gridTemplateRows = `repeat(${classroom.rows}, 60px)`;
                
                for (let r = 0; r < classroom.rows; r++) {
                    for (let c = 0; c < classroom.cols; c++) {
                        const seatId = `${r}-${c}`;
                        const seat = classroom.seats[seatId];
                        
                        const seatElement = document.createElement('div');
                        seatElement.className = `seat ${seat.status}`;
                        seatElement.id = `seat-${seatId}-${containerId}`;
                        seatElement.innerHTML = ''; // é è¨­ç©ºç™½
                        
                        if (seat.assignedStudent) {
                            seatElement.classList.add('assigned');
                            seatElement.innerHTML = `
                                <div>${seat.assignedStudent.id}</div>
                                <small>${seat.assignedStudent.name}</small>
                            `;
                        } else if (seat.occupiedBy) {
                            seatElement.innerHTML = `<small>${seat.occupiedBy}</small>`;
                        }
                        
                        grid.appendChild(seatElement);
                    }
                }
            });
            
            addSeatClickListeners();
        }

        function addSeatClickListeners() {
            const seatElements = document.querySelectorAll('.seat');
            seatElements.forEach(seatElement => {
                seatElement.addEventListener('click', function() {
                    const seatId = this.id.split('-').slice(1, 3).join('-'); // æå– row-col
                    
                    if (currentStep === 4) {
                        // åº§ä½ç®¡ç†æ¨¡å¼
                        toggleSeatStatus(seatId);
                    } else if (currentStep === 5) {
                        // å¦‚æœæ˜¯å·²åˆ†é…çš„åº§ä½ï¼Œå¯ä»¥å–æ¶ˆåˆ†é…
                        if (this.classList.contains('assigned')) {
                            clearSingleAssignment(seatId);
                        }
                    }
                });
            });
        }

        function toggleSeatStatus(seatId) {
            const seat = classrooms[currentClassroom].seats[seatId];
            
            if (seat.status === 'available') {
                seat.status = 'unavailable';
            } else if (seat.status === 'unavailable') {
                seat.status = 'occupied';
                // é¡¯ç¤ºé¸æ“‡å­¸ç”Ÿæ¨¡æ…‹æ¡†
                showSelectStudentModal(seatId);
                return;
            } else if (seat.status === 'occupied') {
                seat.status = 'available';
                seat.occupiedBy = null;
            }
            
            saveToStorage();
            generateSeatingDisplay();
        }

        function showSelectStudentModal(seatId) {
            selectedSeatForOccupation = seatId;
            const modal = document.getElementById('selectStudentModal');
            const container = document.getElementById('availableStudents');
            
            container.innerHTML = '';
            
            const students = classrooms[currentClassroom].students;
            students.forEach(student => {
                const button = document.createElement('button');
                button.className = 'btn';
                button.style.margin = '5px';
                button.style.width = '100%';
                button.textContent = `${student.id} ${student.name}`;
                button.onclick = () => selectStudentForSeat(student);
                container.appendChild(button);
            });
            
            // æ·»åŠ å–æ¶ˆé¸é …
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-secondary';
            cancelButton.style.margin = '5px';
            cancelButton.style.width = '100%';
            cancelButton.textContent = 'å–æ¶ˆä½”é ˜';
            cancelButton.onclick = () => {
                const seat = classrooms[currentClassroom].seats[selectedSeatForOccupation];
                seat.status = 'available';
                seat.occupiedBy = null;
                saveToStorage();
                generateSeatingDisplay();
                closeSelectStudentModal();
            };
            container.appendChild(cancelButton);
            
            modal.style.display = 'block';
        }

        function selectStudentForSeat(student) {
            const seat = classrooms[currentClassroom].seats[selectedSeatForOccupation];
            seat.occupiedBy = `${student.id} ${student.name}`;
            saveToStorage();
            generateSeatingDisplay();
            closeSelectStudentModal();
        }

        function closeSelectStudentModal() {
            document.getElementById('selectStudentModal').style.display = 'none';
            selectedSeatForOccupation = null;
        }

        function setAllSeats(status) {
            Object.keys(classrooms[currentClassroom].seats).forEach(seatId => {
                const seat = classrooms[currentClassroom].seats[seatId];
                seat.status = status;
                if (status !== 'occupied') {
                    seat.occupiedBy = null;
                }
            });
            saveToStorage();
            generateSeatingDisplay();
        }

        function updateRemainingStudents() {
            const container = document.getElementById('remainingStudents');
            if (!currentClassroom || !classrooms[currentClassroom]) {
                container.innerHTML = '';
                return;
            }
            
            const students = classrooms[currentClassroom].students || [];
            
            // ç²å–è¢«ä½”é ˜åº§ä½çš„å­¸ç”ŸID
            const occupiedStudentIds = new Set();
            const seats = classrooms[currentClassroom].seats || {};
            Object.keys(seats).forEach(seatId => {
                if (seats[seatId].status === 'occupied' && seats[seatId].occupiedBy) {
                    const occupiedInfo = seats[seatId].occupiedBy.split(' ');
                    if (occupiedInfo.length > 0) {
                        occupiedStudentIds.add(occupiedInfo[0]);
                    }
                }
            });
            
            // è¨ˆç®—æœªåˆ†é…çš„å­¸ç”Ÿï¼ˆä¸åŒ…æ‹¬è¢«ä½”é ˜åº§ä½çš„å­¸ç”Ÿï¼‰
            const unassignedStudents = students.filter(s => !s.assigned && !occupiedStudentIds.has(s.id));
            
            if (students.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">å°šæœªåŠ å…¥ä»»ä½•å­¸ç”Ÿ</div>';
            } else if (unassignedStudents.length === 0) {
                const assignedCount = students.filter(s => s.assigned).length;
                const occupiedCount = occupiedStudentIds.size;
                container.innerHTML = `
                    <div class="alert alert-success">
                        âœ… æ‰€æœ‰å­¸ç”Ÿéƒ½å·²å®‰æ’ï¼
                        <br><small>å·²åˆ†é…åº§ä½: ${assignedCount}äººï¼Œå›ºå®šåº§ä½: ${occupiedCount}äºº</small>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <h3>å¾…åˆ†é…å­¸ç”Ÿ (${unassignedStudents.length}äºº)ï¼š</h3>
                    <div class="student-list">
                        ${unassignedStudents.map(s => `
                            <div class="student-item">
                                <strong>${s.id}</strong> ${s.name}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function randomAssignSeats() {
            const classroom = classrooms[currentClassroom];
            const students = classroom.students || [];
            const seats = classroom.seats || {};
            
            // é‡ç½®æ‰€æœ‰å­¸ç”Ÿçš„åˆ†é…ç‹€æ…‹
            students.forEach(student => student.assigned = false);
            
            // æ¸…é™¤æ‰€æœ‰åº§ä½çš„å­¸ç”Ÿåˆ†é…
            Object.keys(seats).forEach(seatId => {
                seats[seatId].assignedStudent = null;
            });
            
            // ç²å–å¯ç”¨åº§ä½ï¼ˆä¸åŒ…æ‹¬é—œé–‰å’Œè¢«ä½”é ˜çš„åº§ä½ï¼‰
            const availableSeats = Object.keys(seats).filter(seatId => 
                seats[seatId].status === 'available'
            );
            
            // ç²å–è¢«ä½”é ˜åº§ä½çš„å­¸ç”ŸID
            const occupiedStudentIds = new Set();
            Object.keys(seats).forEach(seatId => {
                if (seats[seatId].status === 'occupied' && seats[seatId].occupiedBy) {
                    const occupiedInfo = seats[seatId].occupiedBy.split(' ');
                    if (occupiedInfo.length > 0) {
                        occupiedStudentIds.add(occupiedInfo[0]);
                    }
                }
            });
            
            // ç²å–å¯åˆ†é…çš„å­¸ç”Ÿï¼ˆæ’é™¤è¢«ä½”é ˜åº§ä½çš„å­¸ç”Ÿï¼‰
            const availableStudents = students.filter(student => 
                !occupiedStudentIds.has(student.id)
            );
            
            // éš¨æ©Ÿåˆ†é…
            const shuffledStudents = [...availableStudents].sort(() => Math.random() - 0.5);
            const shuffledSeats = [...availableSeats].sort(() => Math.random() - 0.5);
            
            const maxAssignments = Math.min(shuffledStudents.length, shuffledSeats.length);
            
            for (let i = 0; i < maxAssignments; i++) {
                const student = shuffledStudents[i];
                const seatId = shuffledSeats[i];
                
                seats[seatId].assignedStudent = student;
                student.assigned = true;
            }
            
            saveToStorage();
            generateSeatingDisplay();
            updateRemainingStudents();
            updateCurrentStudentsList();
        }

        function clearAssignments() {
            const classroom = classrooms[currentClassroom];
            const students = classroom.students || [];
            const seats = classroom.seats || {};
            
            // æ¸…é™¤æ‰€æœ‰åˆ†é…
            students.forEach(student => student.assigned = false);
            Object.keys(seats).forEach(seatId => {
                seats[seatId].assignedStudent = null;
            });
            
            saveToStorage();
            generateSeatingDisplay();
            updateRemainingStudents();
            updateCurrentStudentsList();
        }

        function clearSingleAssignment(seatId) {
            const seat = classrooms[currentClassroom].seats[seatId];
            
            if (seat.assignedStudent) {
                // æ‰¾åˆ°å°æ‡‰çš„å­¸ç”Ÿä¸¦æ¨™è¨˜ç‚ºæœªåˆ†é…
                const student = classrooms[currentClassroom].students.find(s => 
                    s.id === seat.assignedStudent.id
                );
                if (student) {
                    student.assigned = false;
                }
                
                seat.assignedStudent = null;
                saveToStorage();
                generateSeatingDisplay();
                updateRemainingStudents();
                updateCurrentStudentsList();
            }
        }

        function saveArrangement() {
            const classroom = classrooms[currentClassroom];
            const arrangements = [];
            
            Object.keys(classroom.seats || {}).forEach(seatId => {
                const seat = classroom.seats[seatId];
                if (seat.assignedStudent) {
                    arrangements.push({
                        seat: `${seat.row + 1}è¡Œ${seat.col + 1}åˆ—`,
                        student: `${seat.assignedStudent.id} ${seat.assignedStudent.name}`,
                        type: 'éš¨æ©Ÿåˆ†é…'
                    });
                }
                if (seat.status === 'occupied' && seat.occupiedBy) {
                    arrangements.push({
                        seat: `${seat.row + 1}è¡Œ${seat.col + 1}åˆ—`,
                        student: `${seat.occupiedBy}`,
                        type: 'å›ºå®šåº§ä½'
                    });
                }
            });
            
            // ç”Ÿæˆåº§ä½è¡¨æ–‡å­—
            let report = `${currentClassroom} åº§ä½è¡¨\n`;
            report += `ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString()}\n`;
            report += `æ•™å®¤é…ç½®ï¼š${classroom.rows}è¡Œ${classroom.cols}åˆ—\n\n`;
            
            if (arrangements.length === 0) {
                report += 'å°šæœªåˆ†é…ä»»ä½•åº§ä½\n';
            } else {
                // æŒ‰åº§ä½æ’åº
                arrangements.sort((a, b) => {
                    const aMatch = a.seat.match(/(\d+)è¡Œ(\d+)åˆ—/);
                    const bMatch = b.seat.match(/(\d+)è¡Œ(\d+)åˆ—/);
                    const aRow = parseInt(aMatch[1]);
                    const aCol = parseInt(aMatch[2]);
                    const bRow = parseInt(bMatch[1]);
                    const bCol = parseInt(bMatch[2]);
                    
                    if (aRow !== bRow) return aRow - bRow;
                    return aCol - bCol;
                });
                
                arrangements.forEach(arr => {
                    report += `${arr.seat}ï¼š${arr.student} (${arr.type})\n`;
                });
                
                report += `\nçµ±è¨ˆï¼š\n`;
                const randomCount = arrangements.filter(a => a.type === 'éš¨æ©Ÿåˆ†é…').length;
                const fixedCount = arrangements.filter(a => a.type === 'å›ºå®šåº§ä½').length;
                report += `éš¨æ©Ÿåˆ†é…ï¼š${randomCount}äºº\n`;
                report += `å›ºå®šåº§ä½ï¼š${fixedCount}äºº\n`;
                report += `ç¸½è¨ˆï¼š${arrangements.length}äºº\n`;
            }
            
            // å‰µå»ºä¸‹è¼‰é€£çµ
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClassroom}_åº§ä½è¡¨_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success';
            alertDiv.textContent = 'åº§ä½è¡¨å·²ä¸‹è¼‰ï¼';
            document.getElementById('section5').appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const createModal = document.getElementById('createClassModal');
            const selectModal = document.getElementById('selectStudentModal');
            
            if (event.target === createModal) {
                closeCreateClassModal();
            }
            if (event.target === selectModal) {
                closeSelectStudentModal();
            }
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCreateClassModal();
                closeSelectStudentModal();
            }
        });
    </script>
</body>
</html> 