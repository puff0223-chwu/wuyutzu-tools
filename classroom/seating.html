<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸª‘ ç­ç´šåº§ä½å®‰æ’ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header .back-home {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
            font-size: 1.1em;
        }

        .header .back-home:hover {
            opacity: 0.8;
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.95;
            font-size: 1.05em;
        }

        .content {
            padding: 30px;
        }

        .step-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .step-btn {
            background: white;
            border: 2px solid #e0e0e0;
            color: #666;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .step-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }

        .step-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            font-size: 1.4em;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s;
            margin: 6px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }

        .btn-success:hover:not(:disabled) {
            box-shadow: 0 10px 25px rgba(22, 163, 74, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .btn-danger:hover:not(:disabled) {
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.95em;
        }

        input, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 1.05em;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
        }

        .classroom-grid {
            display: grid;
            gap: 12px;
            justify-content: center;
            margin: 30px 0;
            padding: 30px;
            background: white;
            border-radius: 15px;
            border: 3px solid #667eea;
        }

        .seat {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            border: 3px solid transparent;
            position: relative;
            padding: 4px;
            font-size: 0.95em;
        }

        .seat > div:first-child {
            font-size: 1.15em;
            font-weight: 700;
            line-height: 1.2;
        }

        .seat > small, .seat > div:last-child {
            font-size: 0.85em;
            font-weight: 500;
            line-height: 1.2;
            margin-top: 2px;
        }

        .seat.available {
            background: #dcfce7;
            color: #166534;
            border-color: #22c55e;
        }

        .seat.unavailable {
            background: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
            cursor: not-allowed;
        }

        .seat.occupied {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .seat.assigned {
            background: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }

        .seat:not(.unavailable):hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .teacher-desk {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            margin: 20px auto 0;
            width: 140px;
            height: 50px;
            font-size: 1.15em;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .student-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .student-item:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        .student-item.assigned {
            background: #d4edda;
            border-color: #22c55e;
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 1.5em;
            color: #333;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            font-weight: bold;
        }

        .close:hover {
            color: #333;
        }

        .classroom-card {
            background: white;
            padding: 20px;
            margin: 12px;
            border-radius: 15px;
            border: 3px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            min-width: 220px;
            position: relative;
        }

        .classroom-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transform: translateY(-4px);
        }

        .classroom-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);
        }

        .classroom-card h3 {
            margin-bottom: 8px;
            font-size: 1.25em;
            font-weight: 700;
            color: #333;
        }

        .classroom-card p {
            font-size: 0.95em;
            color: #666;
            font-weight: 500;
        }

        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }

        .alert {
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid;
            font-size: 1.05em;
            font-weight: 500;
        }

        .alert-info {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #0d47a1;
        }

        .alert-success {
            background: #d4edda;
            border-color: #22c55e;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .legend {
            display: flex;
            gap: 25px;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05em;
            font-weight: 600;
        }

        .legend-box {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 3px solid;
        }

        footer {
            text-align: center;
            padding: 25px;
            border-top: 2px solid #f0f0f0;
            color: #999;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .seat { width: 65px; height: 65px; font-size: 0.85em; }
            .step-btn { min-width: 100px; padding: 10px 16px; font-size: 0.95em; }
            .btn { padding: 12px 20px; font-size: 1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../index.html" class="back-home">â† è¿”å›é¦–é </a>
            <h1>ğŸª‘ ç­ç´šåº§ä½å®‰æ’ç³»çµ±</h1>
            <p>è¼•é¬†ç®¡ç†æ•™å®¤åº§ä½é…ç½®</p>
        </div>

        <div class="content">
            <div class="step-nav">
                <button class="step-btn active" onclick="goToStep(1)">1ï¸âƒ£ é¸æ“‡æ•™å®¤</button>
                <button class="step-btn" onclick="goToStep(2)">2ï¸âƒ£ æ•™å®¤é…ç½®</button>
                <button class="step-btn" onclick="goToStep(3)">3ï¸âƒ£ å­¸ç”Ÿåå–®</button>
                <button class="step-btn" onclick="goToStep(4)">4ï¸âƒ£ åº§ä½ç®¡ç†</button>
                <button class="step-btn" onclick="goToStep(5)">5ï¸âƒ£ åº§ä½åˆ†é…</button>
                <button class="step-btn" onclick="goToStep(6)">6ï¸âƒ£ å®Œæˆçµæœ</button>
            </div>

            <!-- æ­¥é©Ÿ1: é¸æ“‡æ•™å®¤ -->
            <div id="step1" class="step-content active">
                <div class="section">
                    <h3>ğŸ“š é¸æ“‡æˆ–æ–°å¢æ•™å®¤</h3>
                    <div id="classroomList"></div>
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn btn-success" onclick="showNewClassroomModal()">â• æ–°å¢æ•™å®¤</button>
                    </div>
                </div>
            </div>

            <!-- æ­¥é©Ÿ2: æ•™å®¤é…ç½® -->
            <div id="step2" class="step-content">
                <div class="section">
                    <h3>âš™ï¸ è¨­å®šæ•™å®¤é…ç½®</h3>
                    <div class="alert alert-info">
                        ğŸ“ è¨­å®šæ•™å®¤çš„è¡Œæ•¸å’Œåˆ—æ•¸,å»ºç«‹åº§ä½é…ç½®
                    </div>
                    
                    <label for="rows">æ•™å®¤è¡Œæ•¸:</label>
                    <input type="number" id="rows" min="1" max="10" value="6" onchange="updateClassroomConfig()">
                    
                    <label for="cols">æ•™å®¤åˆ—æ•¸:</label>
                    <input type="number" id="cols" min="1" max="10" value="6" onchange="updateClassroomConfig()">
                    
                    <div class="controls">
                        <button class="btn" onclick="updateClassroomConfig()">âœ… ç¢ºèªé…ç½®</button>
                    </div>
                    
                    <div id="classroomPreview"></div>
                </div>
            </div>

            <!-- æ­¥é©Ÿ3: å­¸ç”Ÿåå–® -->
            <div id="step3" class="step-content">
                <div class="section">
                    <h3>ğŸ‘¥ åŒ¯å…¥å­¸ç”Ÿåå–®</h3>
                    <div class="alert alert-info">
                        ğŸ“ æ¯è¡Œä¸€å€‹å­¸ç”Ÿ,æ ¼å¼: <strong>åº§è™Ÿ å§“å</strong><br>
                        ç¯„ä¾‹: 1 ç‹å°æ˜
                    </div>
                    
                    <label for="studentList">å­¸ç”Ÿæ¸…å–®:</label>
                    <textarea id="studentList" rows="10" placeholder="1 ç‹å°æ˜&#10;2 æå°è¯&#10;3 é™³å¤§æ˜"></textarea>
                    
                    <div class="controls">
                        <button class="btn btn-success" onclick="importStudents()">âœ… åŒ¯å…¥å­¸ç”Ÿ</button>
                        <button class="btn" onclick="showStudentPreview()">ğŸ‘ï¸ é è¦½åå–®</button>
                    </div>
                    
                    <div id="studentPreview"></div>
                </div>
            </div>

            <!-- æ­¥é©Ÿ4: åº§ä½ç®¡ç† -->
            <div id="step4" class="step-content">
                <div class="section">
                    <h3>ğŸ¯ åº§ä½ç‹€æ…‹ç®¡ç†</h3>
                    <div class="alert alert-warning">
                        ğŸ’¡ é»æ“Šåº§ä½åˆ‡æ›ç‹€æ…‹:<br>
                        <strong>å¯ç”¨ â†’ é—œé–‰ â†’ å›ºå®š â†’ å¯ç”¨</strong>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-box available" style="border-color: #22c55e;"></div>
                            <span>å¯ç”¨åº§ä½</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box unavailable" style="border-color: #ef4444;"></div>
                            <span>é—œé–‰åº§ä½</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box occupied" style="border-color: #f59e0b;"></div>
                            <span>å›ºå®šåº§ä½</span>
                        </div>
                    </div>
                    
                    <div id="seatManagement"></div>
                </div>
            </div>

            <!-- æ­¥é©Ÿ5: åº§ä½åˆ†é… -->
            <div id="step5" class="step-content">
                <div class="section">
                    <h3>ğŸ² éš¨æ©Ÿåˆ†é…åº§ä½</h3>
                    <div id="assignmentInfo"></div>
                    
                    <div class="controls">
                        <button class="btn btn-success btn-large" onclick="randomAssign()">ğŸ² é–‹å§‹éš¨æ©Ÿåˆ†é…</button>
                        <button class="btn btn-danger" onclick="clearAllAssignments()">ğŸ”„ æ¸…é™¤æ‰€æœ‰åˆ†é…</button>
                    </div>
                    
                    <div id="classroomDisplay"></div>
                    
                    <div id="unassignedStudents"></div>
                </div>
            </div>

            <!-- æ­¥é©Ÿ6: å®Œæˆçµæœ -->
            <div id="step6" class="step-content">
                <div class="section">
                    <h3>âœ¨ åº§ä½å®‰æ’å®Œæˆ</h3>
                    <div class="alert alert-success">
                        ğŸ‰ åº§ä½å®‰æ’å·²å®Œæˆ!å¯ä»¥ä¸‹è¼‰åº§ä½è¡¨æˆ–æˆªåœ–ä¿å­˜
                    </div>
                    
                    <div class="controls">
                        <button class="btn btn-success" onclick="downloadSeating()">ğŸ“¥ ä¸‹è¼‰åº§ä½è¡¨</button>
                        <button class="btn" onclick="printSeating()">ğŸ–¨ï¸ åˆ—å°åº§ä½è¡¨</button>
                    </div>
                    
                    <div id="finalSeating"></div>
                </div>
            </div>
        </div>

        <footer>ç¨‹å¼è¨­è¨ˆ: å·«é­šå­ Â© 2025</footer>
    </div>

    <!-- Modal: æ–°å¢æ•™å®¤ -->
    <div id="newClassroomModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewClassroomModal()">Ã—</span>
            <h3>æ–°å¢æ•™å®¤</h3>
            <label for="classroomName">æ•™å®¤åç¨±:</label>
            <input type="text" id="classroomName" placeholder="ä¾‹å¦‚: 209æ•™å®¤">
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="createClassroom()">âœ… å»ºç«‹æ•™å®¤</button>
                <button class="btn btn-secondary" onclick="closeNewClassroomModal()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Modal: é¸æ“‡å­¸ç”Ÿ -->
    <div id="selectStudentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSelectStudentModal()">Ã—</span>
            <h3>é¸æ“‡å­¸ç”Ÿ</h3>
            <div id="studentSelectList"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let classrooms = {};
        let currentClassroom = null;
        let currentStep = 1;
        let selectedSeatForOccupied = null;

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadData();
            updateClassroomList();
            updateStepDisplay();
        });

        function loadData() {
            const saved = localStorage.getItem('seating_data_v2');
            if (saved) {
                const data = JSON.parse(saved);
                classrooms = data.classrooms || {};
                currentClassroom = data.currentClassroom || null;
            }
        }

        function saveData() {
            const data = {
                classrooms,
                currentClassroom
            };
            localStorage.setItem('seating_data_v2', JSON.stringify(data));
        }

        // æ•™å®¤ç®¡ç†
        function updateClassroomList() {
            const list = document.getElementById('classroomList');
            if (Object.keys(classrooms).length === 0) {
                list.innerHTML = '<div class="alert alert-info">å°šæœªå»ºç«‹ä»»ä½•æ•™å®¤,è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢æ•™å®¤</div>';
                return;
            }
            
            let html = '';
            for (let id in classrooms) {
                const active = id === currentClassroom ? 'active' : '';
                html += `
                    <div class="classroom-card ${active}" onclick="selectClassroom('${id}')">
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteClassroom('${id}')">Ã—</button>
                        <h3>${classrooms[id].name}</h3>
                        <p>${classrooms[id].rows} è¡Œ Ã— ${classrooms[id].cols} åˆ—</p>
                        <p>å­¸ç”Ÿ: ${classrooms[id].students ? classrooms[id].students.length : 0} äºº</p>
                    </div>
                `;
            }
            list.innerHTML = html;
        }

        function showNewClassroomModal() {
            document.getElementById('newClassroomModal').style.display = 'block';
        }

        function closeNewClassroomModal() {
            document.getElementById('newClassroomModal').style.display = 'none';
            document.getElementById('classroomName').value = '';
        }

        function createClassroom() {
            const name = document.getElementById('classroomName').value.trim();
            if (!name) {
                alert('è«‹è¼¸å…¥æ•™å®¤åç¨±!');
                return;
            }
            
            const id = 'classroom_' + Date.now();
            classrooms[id] = {
                id,
                name,
                rows: 6,
                cols: 6,
                seats: {},
                students: []
            };
            
            initializeSeats(id);
            currentClassroom = id;
            saveData();
            updateClassroomList();
            closeNewClassroomModal();
            goToStep(2);
        }

        function selectClassroom(id) {
            currentClassroom = id;
            saveData();
            updateClassroomList();
            goToStep(2);
        }

        function deleteClassroom(id) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${classrooms[id].name}ã€å—?`)) {
                delete classrooms[id];
                if (currentClassroom === id) {
                    currentClassroom = Object.keys(classrooms)[0] || null;
                }
                saveData();
                updateClassroomList();
            }
        }

        // æ•™å®¤é…ç½®
        function initializeSeats(classroomId) {
            const classroom = classrooms[classroomId];
            classroom.seats = {};
            for (let r = 0; r < classroom.rows; r++) {
                for (let c = 0; c < classroom.cols; c++) {
                    const seatId = `${r}-${c}`;
                    classroom.seats[seatId] = {
                        row: r,
                        col: c,
                        status: 'available',
                        occupiedBy: null,
                        occupiedStudent: null,
                        assignedStudent: null
                    };
                }
            }
        }

        function updateClassroomConfig() {
            if (!currentClassroom) {
                alert('è«‹å…ˆé¸æ“‡æ•™å®¤!');
                return;
            }
            
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            
            if (rows < 1 || cols < 1) {
                alert('è¡Œæ•¸å’Œåˆ—æ•¸å¿…é ˆå¤§æ–¼0!');
                return;
            }
            
            classrooms[currentClassroom].rows = rows;
            classrooms[currentClassroom].cols = cols;
            initializeSeats(currentClassroom);
            saveData();
            
            generateSeatingDisplay();
            alert('âœ… æ•™å®¤é…ç½®å·²æ›´æ–°!');
        }

        // å­¸ç”Ÿç®¡ç†
        function importStudents() {
            if (!currentClassroom) {
                alert('è«‹å…ˆé¸æ“‡æ•™å®¤!');
                return;
            }
            
            const text = document.getElementById('studentList').value.trim();
            if (!text) {
                alert('è«‹è¼¸å…¥å­¸ç”Ÿåå–®!');
                return;
            }
            
            const lines = text.split('\n');
            const students = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                const parts = line.split(/\s+/);
                if (parts.length >= 2) {
                    students.push({
                        id: parts[0],
                        name: parts.slice(1).join(' '),
                        assigned: false,
                        seatId: null
                    });
                }
            });
            
            if (students.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„å­¸ç”Ÿè³‡æ–™!');
                return;
            }
            
            classrooms[currentClassroom].students = students;
            saveData();
            alert(`âœ… æˆåŠŸåŒ¯å…¥ ${students.length} ä½å­¸ç”Ÿ!`);
            showStudentPreview();
        }

        function showStudentPreview() {
            if (!currentClassroom || !classrooms[currentClassroom].students) return;
            
            const students = classrooms[currentClassroom].students;
            const preview = document.getElementById('studentPreview');
            
            if (students.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            let html = '<div class="section"><h3>å­¸ç”Ÿåå–®é è¦½ (' + students.length + ' äºº)</h3>';
            html += '<div class="student-list">';
            students.forEach(s => {
                const assignedClass = s.assigned ? 'assigned' : '';
                html += `<div class="student-item ${assignedClass}">${s.id} ${s.name}</div>`;
            });
            html += '</div></div>';
            
            preview.innerHTML = html;
        }

        // åº§ä½é¡¯ç¤º
        function generateSeatingDisplay() {
            const classroom = classrooms[currentClassroom];
            if (!classroom || !classroom.seats) return;
            
            const containers = ['classroomDisplay', 'seatManagement', 'finalSeating', 'classroomPreview'];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '<div class="classroom-grid" id="seatingGrid_' + containerId + '"></div><div class="teacher-desk">ğŸ“ æ•™å¸«è¬›æ¡Œ</div>';
                
                const grid = document.getElementById('seatingGrid_' + containerId);
                grid.style.gridTemplateColumns = `repeat(${classroom.cols}, 80px)`;
                grid.style.gridTemplateRows = `repeat(${classroom.rows}, 80px)`;
                
                for (let r = 0; r < classroom.rows; r++) {
                    for (let c = 0; c < classroom.cols; c++) {
                        const seatId = `${r}-${c}`;
                        const seat = classroom.seats[seatId];
                        
                        const seatElement = document.createElement('div');
                        seatElement.className = `seat ${seat.status}`;
                        seatElement.id = `seat-${seatId}-${containerId}`;
                        
                        // â˜… é‡é»ä¿®æ­£: å›ºå®šåº§ä½å’Œåˆ†é…åº§ä½éƒ½ç”¨ç›¸åŒæ ¼å¼
                        if (seat.assignedStudent) {
                            seatElement.classList.add('assigned');
                            seatElement.innerHTML = `
                                <div>${seat.assignedStudent.id}</div>
                                <div>${seat.assignedStudent.name}</div>
                            `;
                        } else if (seat.occupiedStudent) {
                            // â˜… ä¿®æ­£: å›ºå®šåº§ä½ä¹Ÿç”¨å…©è¡Œé¡¯ç¤º
                            seatElement.innerHTML = `
                                <div>${seat.occupiedStudent.id}</div>
                                <div>${seat.occupiedStudent.name}</div>
                            `;
                        } else {
                            seatElement.innerHTML = '';
                        }
                        
                        grid.appendChild(seatElement);
                    }
                }
            });
            
            addSeatClickListeners();
        }

        function addSeatClickListeners() {
            const seatElements = document.querySelectorAll('.seat');
            seatElements.forEach(seatElement => {
                seatElement.addEventListener('click', function() {
                    const seatId = this.id.split('-').slice(1, 3).join('-');
                    
                    if (currentStep === 4) {
                        toggleSeatStatus(seatId);
                    } else if (currentStep === 5) {
                        if (this.classList.contains('assigned')) {
                            clearSingleAssignment(seatId);
                        }
                    }
                });
            });
        }

        function toggleSeatStatus(seatId) {
            const seat = classrooms[currentClassroom].seats[seatId];
            
            if (seat.status === 'available') {
                seat.status = 'unavailable';
                seat.occupiedStudent = null;
            } else if (seat.status === 'unavailable') {
                seat.status = 'occupied';
                selectedSeatForOccupied = seatId;
                showSelectStudentModal();
            } else if (seat.status === 'occupied') {
                seat.status = 'available';
                seat.occupiedStudent = null;
            }
            
            saveData();
            generateSeatingDisplay();
        }

        function showSelectStudentModal() {
            const modal = document.getElementById('selectStudentModal');
            const list = document.getElementById('studentSelectList');
            
            const students = classrooms[currentClassroom].students || [];
            const occupiedStudentIds = new Set();
            
            Object.values(classrooms[currentClassroom].seats).forEach(seat => {
                if (seat.occupiedStudent) {
                    occupiedStudentIds.add(seat.occupiedStudent.id);
                }
            });
            
            const availableStudents = students.filter(s => !occupiedStudentIds.has(s.id));
            
            if (availableStudents.length === 0) {
                alert('æ²’æœ‰å¯ç”¨çš„å­¸ç”Ÿäº†!');
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            availableStudents.forEach(student => {
                html += `
                    <div class="student-item" onclick="assignStudentToOccupied('${student.id}')" style="cursor: pointer; margin: 8px 0;">
                        ${student.id} ${student.name}
                    </div>
                `;
            });
            html += '</div>';
            
            list.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeSelectStudentModal() {
            document.getElementById('selectStudentModal').style.display = 'none';
            selectedSeatForOccupied = null;
        }

        function assignStudentToOccupied(studentId) {
            if (!selectedSeatForOccupied) return;
            
            const student = classrooms[currentClassroom].students.find(s => s.id === studentId);
            if (!student) return;
            
            const seat = classrooms[currentClassroom].seats[selectedSeatForOccupied];
            seat.occupiedStudent = {id: student.id, name: student.name};
            
            saveData();
            generateSeatingDisplay();
            closeSelectStudentModal();
        }

        // éš¨æ©Ÿåˆ†é…
        function randomAssign() {
            if (!currentClassroom) {
                alert('è«‹å…ˆé¸æ“‡æ•™å®¤!');
                return;
            }
            
            const classroom = classrooms[currentClassroom];
            const students = classroom.students || [];
            
            // æ¸…é™¤ä¹‹å‰çš„åˆ†é…
            Object.values(classroom.seats).forEach(seat => {
                if (seat.status !== 'occupied') {
                    seat.assignedStudent = null;
                }
            });
            
            students.forEach(s => {
                s.assigned = false;
                s.seatId = null;
            });
            
            // æ”¶é›†å¯ç”¨åº§ä½
            const availableSeats = [];
            for (let seatId in classroom.seats) {
                const seat = classroom.seats[seatId];
                if (seat.status === 'available') {
                    availableSeats.push(seatId);
                }
            }
            
            // æ”¶é›†æœªè¢«å›ºå®šçš„å­¸ç”Ÿ
            const occupiedStudentIds = new Set();
            Object.values(classroom.seats).forEach(seat => {
                if (seat.occupiedStudent) {
                    occupiedStudentIds.add(seat.occupiedStudent.id);
                }
            });
            
            const unassignedStudents = students.filter(s => !occupiedStudentIds.has(s.id));
            
            // éš¨æ©Ÿåˆ†é…
            const shuffledSeats = availableSeats.sort(() => Math.random() - 0.5);
            const shuffledStudents = unassignedStudents.sort(() => Math.random() - 0.5);
            
            const minCount = Math.min(shuffledSeats.length, shuffledStudents.length);
            
            for (let i = 0; i < minCount; i++) {
                const seatId = shuffledSeats[i];
                const student = shuffledStudents[i];
                
                classroom.seats[seatId].assignedStudent = {
                    id: student.id,
                    name: student.name
                };
                
                student.assigned = true;
                student.seatId = seatId;
            }
            
            saveData();
            generateSeatingDisplay();
            updateAssignmentInfo();
            
            alert('âœ… éš¨æ©Ÿåˆ†é…å®Œæˆ!');
        }

        function updateAssignmentInfo() {
            if (!currentClassroom) return;
            
            const classroom = classrooms[currentClassroom];
            const students = classroom.students || [];
            
            const assignedCount = students.filter(s => s.assigned).length;
            const occupiedCount = Object.values(classroom.seats).filter(s => s.occupiedStudent).length;
            const unassignedStudents = students.filter(s => !s.assigned);
            
            const unassignedDiv = document.getElementById('unassignedStudents');
            const infoDiv = document.getElementById('assignmentInfo');
            
            let infoHtml = `
                <div class="alert alert-info">
                    ğŸ“Š <strong>åˆ†é…çµ±è¨ˆ:</strong><br>
                    ç¸½å­¸ç”Ÿæ•¸: ${students.length} äºº<br>
                    å·²åˆ†é…åº§ä½: ${assignedCount} äºº<br>
                    å›ºå®šåº§ä½: ${occupiedCount} äºº<br>
                    æœªåˆ†é…: ${unassignedStudents.length} äºº
                </div>
            `;
            
            if (infoDiv) infoDiv.innerHTML = infoHtml;
            
            if (unassignedStudents.length > 0) {
                let html = '<div class="section"><h3>æœªåˆ†é…å­¸ç”Ÿ (' + unassignedStudents.length + ' äºº)</h3>';
                html += '<div class="student-list">';
                unassignedStudents.forEach(s => {
                    html += `<div class="student-item">${s.id} ${s.name}</div>`;
                });
                html += '</div></div>';
                if (unassignedDiv) unassignedDiv.innerHTML = html;
            } else {
                if (unassignedDiv) unassignedDiv.innerHTML = '';
            }
        }

        function clearAllAssignments() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åº§ä½åˆ†é…å—?')) return;
            
            const classroom = classrooms[currentClassroom];
            Object.values(classroom.seats).forEach(seat => {
                if (seat.status !== 'occupied') {
                    seat.assignedStudent = null;
                }
            });
            
            classroom.students.forEach(s => {
                s.assigned = false;
                s.seatId = null;
            });
            
            saveData();
            generateSeatingDisplay();
            updateAssignmentInfo();
        }

        function clearSingleAssignment(seatId) {
            const seat = classrooms[currentClassroom].seats[seatId];
            if (seat.assignedStudent) {
                const student = classrooms[currentClassroom].students.find(s => s.id === seat.assignedStudent.id);
                if (student) {
                    student.assigned = false;
                    student.seatId = null;
                }
                seat.assignedStudent = null;
                saveData();
                generateSeatingDisplay();
                updateAssignmentInfo();
            }
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function downloadSeating() {
            if (!currentClassroom) return;
            
            const classroom = classrooms[currentClassroom];
            const data = [['è¡Œ', 'åˆ—', 'åº§è™Ÿ', 'å§“å', 'ç‹€æ…‹']];
            
            for (let seatId in classroom.seats) {
                const seat = classroom.seats[seatId];
                const [row, col] = seatId.split('-');
                
                let studentInfo = '-';
                let status = 'ç©ºä½';
                
                if (seat.assignedStudent) {
                    studentInfo = `${seat.assignedStudent.id} ${seat.assignedStudent.name}`;
                    status = 'åˆ†é…';
                } else if (seat.occupiedStudent) {
                    studentInfo = `${seat.occupiedStudent.id} ${seat.occupiedStudent.name}`;
                    status = 'å›ºå®š';
                } else if (seat.status === 'unavailable') {
                    status = 'é—œé–‰';
                }
                
                data.push([
                    parseInt(row) + 1,
                    parseInt(col) + 1,
                    seat.assignedStudent ? seat.assignedStudent.id : (seat.occupiedStudent ? seat.occupiedStudent.id : '-'),
                    seat.assignedStudent ? seat.assignedStudent.name : (seat.occupiedStudent ? seat.occupiedStudent.name : '-'),
                    status
                ]);
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 6}, {wch: 6}, {wch: 10}, {wch: 15}, {wch: 10}];
            XLSX.utils.book_append_sheet(wb, ws, 'åº§ä½è¡¨');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${classroom.name}_åº§ä½è¡¨_${date}.xlsx`);
        }

        function printSeating() {
            window.print();
        }

        // æ­¥é©Ÿå°èˆª
        function goToStep(step) {
            if (!currentClassroom && step > 1) {
                alert('è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹æ•™å®¤!');
                return;
            }
            
            currentStep = step;
            updateStepDisplay();
            
            if (step === 2) {
                const classroom = classrooms[currentClassroom];
                document.getElementById('rows').value = classroom.rows;
                document.getElementById('cols').value = classroom.cols;
                generateSeatingDisplay();
            } else if (step === 3) {
                showStudentPreview();
            } else if (step === 4) {
                generateSeatingDisplay();
            } else if (step === 5) {
                generateSeatingDisplay();
                updateAssignmentInfo();
            } else if (step === 6) {
                generateSeatingDisplay();
            }
        }

        function updateStepDisplay() {
            for (let i = 1; i <= 6; i++) {
                const stepContent = document.getElementById('step' + i);
                const stepBtn = document.querySelectorAll('.step-btn')[i - 1];
                
                if (i === currentStep) {
                    stepContent.classList.add('active');
                    stepBtn.classList.add('active');
                } else {
                    stepContent.classList.remove('active');
                    stepBtn.classList.remove('active');
                }
            }
        }
    </script>
</body>
</html>
