<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¹ æ‰“æƒå·¥ä½œå¾µæ‰ç³»çµ± v3.3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header .back-home {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .header .version { font-size: 0.9em; opacity: 0.9; }
        .tabs {
            display: flex;
            background: #f0f0f0;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 100px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            border: none;
            background: none;
            transition: all 0.3s;
        }
        .tab:hover { background: #e0e0e0; }
        .tab.active {
            background: white;
            color: #c41e3a;
            border-bottom: 3px solid #c41e3a;
        }
        .content { padding: 25px; }
        .system { display: none; }
        .system.active { display: block; }
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            font-size: 1.3em;
        }
        .btn {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(196, 30, 58, 0.3);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .btn-small { padding: 8px 16px; font-size: 0.9em; }
        .btn-large { padding: 15px 35px; font-size: 1.2em; }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid;
        }
        .alert-info { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
        .alert-success { background: #d4edda; border-color: #16a34a; color: #155724; }
        .alert-warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .alert-danger { background: #fee; border-color: #dc2626; color: #991b1b; }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 1em;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .resource-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        .resource-item .priority {
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .resource-item .name { flex: 1; font-weight: bold; font-size: 1.1em; }
        .resource-item .rate {
            background: #e3f2fd;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #1565c0;
        }
        .job-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .job-card {
            background: white;
            padding: 18px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        .job-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .job-card .title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .job-card .count {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 12px;
        }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .student-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
        .lottery-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #667eea;
        }
        .lottery-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .participant-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .participant-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 4px solid #2196f3;
        }
        .participant-item.selected {
            background: #d4edda;
            border-left-color: #16a34a;
        }
        .participant-item.rejected {
            background: #fee;
            border-left-color: #dc2626;
            opacity: 0.7;
        }
        .participant-name {
            font-weight: bold;
            font-size: 1.05em;
        }
        .participant-resource {
            color: #666;
            font-size: 0.9em;
        }
        .participant-weight {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin-right: 8px;
        }
        .participant-probability {
            background: #16a34a;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.95em;
        }
        .probability-explanation {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 0.9em;
            color: #856404;
        }
        .lottery-result {
            text-align: center;
            padding: 30px;
            font-size: 1.5em;
            font-weight: bold;
            color: #16a34a;
            display: none;
        }
        .lottery-result.show {
            display: block;
            animation: zoomIn 0.5s ease-out;
        }
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: absolute;
            animation: confetti-fall 3s linear forwards;
        }
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        .result-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        .result-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .result-table tr:hover { background: #f8f9fa; }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-selected {
            background: #d4edda;
            color: #155724;
        }
        .status-rejected {
            background: #fee;
            color: #991b1b;
        }
        .status-random {
            background: #cfe2ff;
            color: #084298;
        }
        footer {
            text-align: center;
            padding: 20px;
            border-top: 2px solid #f0f0f0;
            color: #999;
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            .container { margin: 0; border-radius: 0; }
            .header h1 { font-size: 1.5em; }
            .tabs { flex-direction: column; }
            .job-grid, .student-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../index.html" class="back-home">â† è¿”å›é¦–é </a>
            <h1>ğŸ§¹ æ‰“æƒå·¥ä½œå¾µæ‰ç³»çµ±</h1>
            <p class="version">v3.3 æœ€çµ‚ç‰ˆ - åŠ æ¬Šéš¨æ©Ÿæ©Ÿç‡æ¨¡å‹</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('resources')">ğŸ’ è³‡æºè¨­å®š</button>
            <button class="tab" onclick="switchTab('jobs')">ğŸ“‹ æ‰“æƒé …ç›®</button>
            <button class="tab" onclick="switchTab('students')">ğŸ‘¥ ç­ç´šåå–®</button>
            <button class="tab" onclick="switchTab('upload')">ğŸ“¤ ä¸Šå‚³åå–®</button>
            <button class="tab" onclick="switchTab('lottery')">ğŸ° å¾µé¸æŠ½ç±¤</button>
            <button class="tab" onclick="switchTab('results')">ğŸ† å®Œæ•´çµæœ</button>
        </div>

        <div class="content">
            <!-- è³‡æºè¨­å®š -->
            <div id="tab-resources" class="system active">
                <div class="section">
                    <h3>ğŸ’ è³‡æºç¨®é¡èˆ‡æ¬Šé‡è¨­å®š</h3>
                    <div class="alert alert-info">
                        ğŸ“Œ <strong>åŠ æ¬Šéš¨æ©Ÿæ©Ÿç‡æ¨¡å‹èªªæ˜:</strong><br>
                        â€¢ æŠ•å…¥çš„è³‡æºæœƒè½‰æ›ç‚ºã€Œæ¬Šé‡ã€<br>
                        â€¢ å¯¦éš›ä¸­é¸æ©Ÿç‡ = å€‹äººæ¬Šé‡ Ã· æ‰€æœ‰åƒèˆ‡è€…ç¸½æ¬Šé‡<br>
                        â€¢ æŠ•å…¥è¶Šå¤š,æ¬Šé‡è¶Šé«˜,ä¸­é¸æ©Ÿç‡è¶Šå¤§<br>
                        â€¢ ç¬¦åˆæ•¸å­¸å®šç¾©,å…¬å¹³ä¸”æº–ç¢º!
                    </div>

                    <div id="resourceList"></div>

                    <div style="margin-top: 20px;">
                        <input type="text" id="newResourceName" placeholder="è³‡æºåç¨± (ä¾‹å¦‚:å¯¶çŸ³)">
                        <input type="number" id="newResourceRate" placeholder="æ¯å–®ä½æ¬Šé‡å€¼ (ä¾‹å¦‚:10)" min="0.1" step="0.1">
                        <input type="number" id="newResourceUnit" placeholder="è¨ˆç®—å–®ä½ (ä¾‹å¦‚:1è¡¨ç¤ºæ¯1å€‹, 30è¡¨ç¤ºæ¯30å€‹)" min="1" value="1">
                        <button class="btn btn-success" onclick="addResource()">â• æ–°å¢è³‡æº</button>
                    </div>
                </div>
            </div>

            <!-- æ‰“æƒé …ç›® -->
            <div id="tab-jobs" class="system">
                <div class="section">
                    <h3>ğŸ“‹ æ‰“æƒé …ç›®ç®¡ç†</h3>
                    <input type="text" id="jobName" placeholder="æ‰“æƒé …ç›®åç¨± (ä¾‹å¦‚:æ“¦çª—æˆ¶)">
                    <input type="number" id="jobCount" min="1" value="1" placeholder="éœ€è¦äººæ•¸">
                    <button class="btn btn-success" onclick="addJob()">â• æ–°å¢é …ç›®</button>
                </div>

                <div class="section">
                    <h3>ğŸ“‹ ç›®å‰æ‰“æƒé …ç›®</h3>
                    <div class="job-grid" id="jobList"></div>
                </div>
            </div>

            <!-- ç­ç´šåå–® -->
            <div id="tab-students" class="system">
                <div class="section">
                    <h3>ğŸ‘¥ å…¨ç­å­¸ç”Ÿåå–®</h3>
                    <div class="alert alert-info">
                        ğŸ“Œ è«‹å…ˆä¸Šå‚³å…¨ç­å­¸ç”Ÿåå–®<br>
                        ç”¨æ–¼æœ€å¾Œçµ±è¨ˆæœªåˆ†é…å­¸ç”Ÿ,ä¸¦é€²è¡Œéš¨æ©Ÿåˆ†é…å‰©é¤˜è·ç¼º
                    </div>

                    <div style="margin:15px 0;">
                        <button class="btn btn-secondary" onclick="document.getElementById('studentExcel').click()">ğŸ“¤ ä¸Šå‚³ç­ç´šåå–®Excel</button>
                        <button class="btn btn-success" onclick="downloadStudentTemplate()">ğŸ“¥ ä¸‹è¼‰ç¯„ä¾‹</button>
                        <button class="btn btn-danger" onclick="clearStudents()">ğŸ—‘ï¸ æ¸…ç©ºåå–®</button>
                        <input type="file" id="studentExcel" accept=".xlsx,.xls" style="display:none" onchange="importStudents(event)">
                    </div>

                    <div class="alert alert-warning" style="font-size:0.9em;">
                        <strong>Excel æ ¼å¼:</strong> åº§è™Ÿ | å§“å<br>
                        ç¯„ä¾‹: 1 | å°æ˜
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ“‹ ç›®å‰åå–® (<span id="studentCount">0</span> äºº)</h3>
                    <div class="student-grid" id="studentList"></div>
                </div>
            </div>

            <!-- ä¸Šå‚³åå–® -->
            <div id="tab-upload" class="system">
                <div class="section">
                    <h3>ğŸ“¤ ä¸Šå‚³æœ¬è¼ªå¾µé¸åå–®</h3>
                    
                    <div class="alert alert-info">
                        ğŸ“¥ <strong>Excel æ ¼å¼è¦æ±‚:</strong><br>
                        æ¬„ä½: åº§è™Ÿ | å§“å | åƒèˆ‡æ‰“æƒé …ç›® | æŠ•å…¥è³‡æºç¨®é¡ | è³‡æºæŠ•å…¥æ•¸é‡ | å¾µé¸è¼ªæ¬¡<br>
                        <a href="#" onclick="downloadTemplate(); return false;" style="color:#c41e3a; font-weight:bold;">ğŸ“¥ é»æ­¤ä¸‹è¼‰ç¯„ä¾‹æª”æ¡ˆ</a>
                    </div>

                    <div class="alert alert-warning">
                        âš ï¸ <strong>é‡è¦è¦å‰‡:</strong><br>
                        â€¢ æ¯æ¬¡åªèƒ½æŠ•å…¥ä¸€ç¨®è³‡æº(æ··ç”¨å°‡è¢«æ‹’çµ•)<br>
                        â€¢ å·²ä¸­é¸è€…ç„¡æ³•åƒèˆ‡å¾ŒçºŒè¼ªæ¬¡<br>
                        â€¢ æœªä¸­é¸è€…è³‡æºä»æœƒæ‰£é™¤
                    </div>

                    <div style="background:#e3f2fd; padding:15px; border-radius:10px; margin:15px 0;">
                        <strong>ğŸ“Š ç›®å‰ç‹€æ…‹:</strong><br>
                        ç›®å‰è¼ªæ¬¡: <span id="currentRound" style="color:#c41e3a; font-weight:bold; font-size:1.2em;">0</span> è¼ª<br>
                        å·²åˆ†é…äººæ•¸: <span id="assignedCount" style="color:#16a34a; font-weight:bold;">0</span> äºº<br>
                        æœ¬è¼ªåƒèˆ‡: <span id="thisRoundCount" style="color:#2196f3; font-weight:bold;">0</span> äºº
                    </div>

                    <div class="upload-area" onclick="document.getElementById('excelFile').click()">
                        <div style="font-size:3em; margin-bottom:15px;">ğŸ“</div>
                        <div style="font-size:1.3em; font-weight:bold; margin-bottom:10px;">
                            é»æ“Šä¸Šå‚³ç¬¬ <span id="nextRound">1</span> è¼ªå¾µé¸åå–®
                        </div>
                        <div style="color:#666; font-size:0.95em;">
                            æ”¯æ´ .xlsx å’Œ .xls æ ¼å¼
                        </div>
                    </div>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" onchange="uploadExcel(event)">

                    <div id="uploadStatus"></div>
                </div>
            </div>

            <!-- å¾µé¸æŠ½ç±¤ -->
            <div id="tab-lottery" class="system">
                <div class="section">
                    <h3>ğŸ° åˆ†é …ç›®é€²è¡Œå¾µé¸æŠ½ç±¤</h3>
                    
                    <div class="alert alert-info">
                        ğŸ² <strong>åŠ æ¬Šéš¨æ©ŸæŠ½ç±¤èªªæ˜:</strong><br>
                        â€¢ ç³»çµ±ä½¿ç”¨ã€ŒåŠ æ¬Šéš¨æ©Ÿã€æ¼”ç®—æ³•<br>
                        â€¢ æ¯äººçš„æ¬Šé‡ = æŠ•å…¥è³‡æºè½‰æ›çš„æ•¸å€¼<br>
                        â€¢ å¯¦éš›ä¸­é¸æ©Ÿç‡ = å€‹äººæ¬Šé‡ Ã· ç¸½æ¬Šé‡<br>
                        â€¢ æ¬Šé‡è¶Šé«˜,ä¸­é¸æ©Ÿç‡è¶Šå¤§<br>
                        â€¢ ç¬¦åˆæ•¸å­¸æ©Ÿç‡å®šç¾©,å…¬å¹³æº–ç¢º!
                    </div>

                    <div id="lotteryArea"></div>
                </div>
            </div>

            <!-- å®Œæ•´çµæœ -->
            <div id="tab-results" class="system">
                <div class="section">
                    <h3>ğŸ† å®Œæ•´å¾µé¸çµæœ</h3>
                    <div id="resultSummary"></div>
                    
                    <div id="randomAssignArea"></div>
                    
                    <div id="resultContent"></div>
                    
                    <div style="margin-top:20px;">
                        <button class="btn btn-success" onclick="exportByJob()">ğŸ“¥ ä¸‹è¼‰çµæœ(ä¾æ‰“æƒé …ç›®)</button>
                        <button class="btn btn-success" onclick="exportByStudent()">ğŸ“¥ ä¸‹è¼‰çµæœ(ä¾å­¸ç”Ÿçµ±è¨ˆ)</button>
                        <button class="btn btn-danger" onclick="resetAll()">ğŸ”„ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                    </div>
                </div>
            </div>
        </div>

        <footer>ç¨‹å¼è¨­è¨ˆ:å·«é­šå­ Â© 2025 | v3.3 æœ€çµ‚ç‰ˆ</footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ========================================
        // å…¨åŸŸè®Šæ•¸
        // ========================================
        let resources = [
            {name:'é‡‘å¹£', rate:1, unit:30, priority:1},
            {name:'è€å¸«ç°½åå¡', rate:20, unit:1, priority:2},
            {name:'æœ€å¼·ç‹ç‰Œ', rate:50, unit:1, priority:3}
        ];
        
        // â˜… é è¨­æ‰“æƒé …ç›®
        let jobs = [
            {id: 1, name: '[æ•™å®¤]åœ°æ¿å¤©èŠ±æ¿', count: 5},
            {id: 2, name: '[æ•™å®¤]å€’åƒåœ¾(å«é™½å°åœ°æ¿)', count: 3},
            {id: 3, name: '[æ•™å®¤]é»‘æ¿æ•™å¸«æ¡Œ', count: 2},
            {id: 4, name: '[æ•™å®¤]æ›¸æ«ƒé›»è…¦æ«ƒåœ–æ›¸æ«ƒ', count: 4},
            {id: 5, name: '[æ•™å®¤]æ“¦é–€çª—', count: 5},
            {id: 6, name: '[æ•™å®¤]æ´—æ‰‹å°é£²æ°´æ©Ÿ', count: 2},
            {id: 7, name: '[æ•™å®¤]æŠ¬é¤(å«å»šé¤˜ã€æ¸…æ½”)', count: 3}
        ];
        
        let students = [];
        let currentRoundData = [];
        let allResults = [];
        let selectedStudents = new Set();
        let currentRound = 0;

        // ========================================
        // åˆå§‹åŒ–
        // ========================================
        window.addEventListener('load', () => {
            loadData();
            updateAll();
        });

        function loadData() {
            const saved = localStorage.getItem('cleaning_v33_data');
            if(saved) {
                const data = JSON.parse(saved);
                resources = data.resources || resources;
                jobs = data.jobs || jobs;
                students = data.students || [];
                allResults = data.results || [];
                selectedStudents = new Set(data.selected || []);
                currentRound = data.round || 0;
            }
        }

        function saveData() {
            const data = {
                resources,
                jobs,
                students,
                results: allResults,
                selected: Array.from(selectedStudents),
                round: currentRound
            };
            localStorage.setItem('cleaning_v33_data', JSON.stringify(data));
        }

        function updateAll() {
            updateResourceList();
            updateJobList();
            updateStudentList();
            updateStats();
            updateResults();
            generateLotteryArea();
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.system').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
            
            if(name === 'lottery') {
                generateLotteryArea();
            }
            if(name === 'results') {
                updateResults();
            }
        }

        // ========================================
        // æ ¸å¿ƒåŠŸèƒ½: è¨ˆç®—æ¬Šé‡
        // ========================================
        function calculateWeight(resourceName, amount) {
            const res = resources.find(r => r.name === resourceName);
            if(!res) return 0;
            const weight = Math.floor(amount / res.unit) * res.rate;
            return weight;
        }

        // ========================================
        // æ ¸å¿ƒåŠŸèƒ½: åŠ æ¬Šéš¨æ©ŸæŠ½å–
        // ========================================
        function weightedRandomSelection(participants, count) {
            if(participants.length === 0) return {winners: [], losers: []};
            if(count <= 0) return {winners: [], losers: participants};
            
            const winners = [];
            const pool = [...participants];
            
            for(let i = 0; i < count && pool.length > 0; i++) {
                const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
                
                if(totalWeight === 0) {
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    winners.push(pool.splice(randomIndex, 1)[0]);
                    continue;
                }
                
                let random = Math.random() * totalWeight;
                
                for(let j = 0; j < pool.length; j++) {
                    random -= pool[j].weight;
                    if(random <= 0) {
                        winners.push(pool.splice(j, 1)[0]);
                        break;
                    }
                }
            }
            
            return {winners, losers: pool};
        }

        // ========================================
        // è³‡æºç®¡ç†
        // ========================================
        function updateResourceList() {
            const list = document.getElementById('resourceList');
            if(resources.length === 0) {
                list.innerHTML = '<div style="padding:20px;text-align:center;color:#999">å°šç„¡è³‡æºè¨­å®š</div>';
                return;
            }
            list.innerHTML = resources.map((r, i) => `
                <div class="resource-item">
                    <div class="priority">${r.priority}</div>
                    <div class="name">${r.name}</div>
                    <div class="rate">æ¯ ${r.unit} å€‹ â†’ æ¬Šé‡ +${r.rate}</div>
                    <div style="display:flex;gap:5px;">
                        <button class="btn btn-small btn-secondary" onclick="moveResource(${i},'up')" ${i===0?'disabled':''}>â†‘</button>
                        <button class="btn btn-small btn-secondary" onclick="moveResource(${i},'down')" ${i===resources.length-1?'disabled':''}>â†“</button>
                        <button class="btn btn-small btn-danger" onclick="deleteResource(${i})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function addResource() {
            const name = document.getElementById('newResourceName').value.trim();
            const rate = parseFloat(document.getElementById('newResourceRate').value);
            const unit = parseInt(document.getElementById('newResourceUnit').value);
            
            if(!name) { alert('è«‹è¼¸å…¥è³‡æºåç¨±'); return; }
            if(!rate || rate <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¬Šé‡å€¼'); return; }
            if(!unit || unit <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è¨ˆç®—å–®ä½'); return; }
            if(resources.some(r => r.name === name)) { alert('è³‡æºå·²å­˜åœ¨'); return; }
            
            resources.push({name, rate, unit, priority: resources.length + 1});
            document.getElementById('newResourceName').value = '';
            document.getElementById('newResourceRate').value = '';
            document.getElementById('newResourceUnit').value = '1';
            saveData();
            updateResourceList();
        }

        function moveResource(i, dir) {
            if(dir === 'up' && i > 0) {
                [resources[i], resources[i-1]] = [resources[i-1], resources[i]];
            } else if(dir === 'down' && i < resources.length - 1) {
                [resources[i], resources[i+1]] = [resources[i+1], resources[i]];
            }
            resources.forEach((r, idx) => r.priority = idx + 1);
            saveData();
            updateResourceList();
        }

        function deleteResource(i) {
            if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${resources[i].name}ã€?`)) {
                resources.splice(i, 1);
                resources.forEach((r, idx) => r.priority = idx + 1);
                saveData();
                updateResourceList();
            }
        }

        // ========================================
        // æ‰“æƒé …ç›®ç®¡ç†
        // ========================================
        function updateJobList() {
            const list = document.getElementById('jobList');
            if(jobs.length === 0) {
                list.innerHTML = '<div style="padding:40px;text-align:center;color:#999">å°šç„¡æ‰“æƒé …ç›®<br>è«‹å…ˆæ–°å¢é …ç›®</div>';
                return;
            }
            list.innerHTML = jobs.map((j, i) => `
                <div class="job-card">
                    <div class="title">ğŸ§¹ ${j.name}</div>
                    <div class="count">éœ€è¦ ${j.count} äºº</div>
                    <div style="font-size:0.9em;color:#666;margin-bottom:10px;">
                        å·²åˆ†é…: ${allResults.filter(r => r.job === j.name && r.status === 'selected').length} äºº
                    </div>
                    <button class="btn btn-small btn-secondary" onclick="editJob(${i})">âœï¸ ç·¨è¼¯</button>
                    <button class="btn btn-small btn-danger" onclick="deleteJob(${i})">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            `).join('');
        }

        function addJob() {
            const name = document.getElementById('jobName').value.trim();
            const count = parseInt(document.getElementById('jobCount').value);
            if(!name) { alert('è«‹è¼¸å…¥é …ç›®åç¨±'); return; }
            if(count < 1) { alert('äººæ•¸è‡³å°‘1äºº'); return; }
            jobs.push({id: Date.now(), name, count});
            document.getElementById('jobName').value = '';
            document.getElementById('jobCount').value = '1';
            saveData();
            updateAll();
        }

        function editJob(i) {
            const newName = prompt('ä¿®æ”¹é …ç›®åç¨±:', jobs[i].name);
            if(newName && newName.trim()) jobs[i].name = newName.trim();
            const newCount = prompt('ä¿®æ”¹äººæ•¸:', jobs[i].count);
            if(newCount && parseInt(newCount) > 0) jobs[i].count = parseInt(newCount);
            saveData();
            updateAll();
        }

        function deleteJob(i) {
            if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${jobs[i].name}ã€?`)) {
                jobs.splice(i, 1);
                saveData();
                updateAll();
            }
        }

        // ========================================
        // ç­ç´šåå–®ç®¡ç†
        // ========================================
        function updateStudentList() {
            document.getElementById('studentCount').textContent = students.length;
            const list = document.getElementById('studentList');
            if(students.length === 0) {
                list.innerHTML = '<div style="padding:40px;text-align:center;color:#999">å°šæœªä¸Šå‚³ç­ç´šåå–®</div>';
                return;
            }
            list.innerHTML = students.map(s => `
                <div class="student-item">${s.seat} ${s.name}</div>
            `).join('');
        }

        function importStudents(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);
                    
                    students = json.map(row => ({
                        seat: row['åº§è™Ÿ'],
                        name: row['å§“å']
                    }));
                    
                    saveData();
                    updateStudentList();
                    alert(`âœ… æˆåŠŸåŒ¯å…¥ ${students.length} ä½å­¸ç”Ÿ!`);
                } catch(err) {
                    alert('âŒ æª”æ¡ˆè®€å–å¤±æ•—: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function clearStudents() {
            if(confirm('ç¢ºå®šæ¸…ç©ºç­ç´šåå–®?')) {
                students = [];
                saveData();
                updateStudentList();
            }
        }

        function downloadStudentTemplate() {
            const data = [['åº§è™Ÿ', 'å§“å']];
            for(let i = 1; i <= 35; i++) {
                data.push([i, `å­¸ç”Ÿ${i}è™Ÿ`]);
            }
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:10}, {wch:15}];
            XLSX.utils.book_append_sheet(wb, ws, 'å­¸ç”Ÿåå–®');
            XLSX.writeFile(wb, 'ç­ç´šåå–®ç¯„ä¾‹.xlsx');
        }

        // ========================================
        // Excel ä¸Šå‚³èˆ‡é©—è­‰
        // ========================================
        function uploadExcel(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);
                    
                    const required = ['åº§è™Ÿ', 'å§“å', 'åƒèˆ‡æ‰“æƒé …ç›®', 'æŠ•å…¥è³‡æºç¨®é¡', 'è³‡æºæŠ•å…¥æ•¸é‡', 'å¾µé¸è¼ªæ¬¡'];
                    if(json.length === 0) {
                        alert('âŒ Excel æª”æ¡ˆæ²’æœ‰è³‡æ–™!');
                        return;
                    }
                    
                    const first = json[0];
                    const missing = required.filter(f => !(f in first));
                    if(missing.length > 0) {
                        alert(`âŒ ç¼ºå°‘å¿…è¦æ¬„ä½: ${missing.join(', ')}\n\nè«‹ç¢ºèªæ¬„ä½åç¨±å®Œå…¨ä¸€è‡´!`);
                        return;
                    }
                    
                    const validated = [];
                    const errors = [];
                    
                    json.forEach((row, idx) => {
                        const lineNum = idx + 2;
                        
                        if(selectedStudents.has(row['å§“å'])) {
                            errors.push(`ç¬¬${lineNum}è¡Œ: ${row['å§“å']} å·²ç¶“ä¸­é¸,ç„¡æ³•åƒèˆ‡`);
                            return;
                        }
                        
                        const resName = row['æŠ•å…¥è³‡æºç¨®é¡'];
                        if(!resources.some(r => r.name === resName)) {
                            errors.push(`ç¬¬${lineNum}è¡Œ: è³‡æºç¨®é¡ã€Œ${resName}ã€ä¸å­˜åœ¨`);
                            return;
                        }
                        
                        const amount = parseFloat(row['è³‡æºæŠ•å…¥æ•¸é‡']);
                        if(isNaN(amount) || amount <= 0) {
                            errors.push(`ç¬¬${lineNum}è¡Œ: è³‡æºæ•¸é‡ç„¡æ•ˆ`);
                            return;
                        }
                        
                        const weight = calculateWeight(resName, amount);
                        
                        validated.push({
                            seat: row['åº§è™Ÿ'],
                            name: row['å§“å'],
                            job: row['åƒèˆ‡æ‰“æƒé …ç›®'],
                            resource: resName,
                            amount: amount,
                            round: row['å¾µé¸è¼ªæ¬¡'],
                            weight: weight
                        });
                    });
                    
                    if(errors.length > 0) {
                        alert('âŒ è³‡æ–™é©—è­‰å¤±æ•—:\n\n' + errors.join('\n'));
                        return;
                    }
                    
                    if(validated.length === 0) {
                        alert('âŒ æ²’æœ‰æœ‰æ•ˆçš„åƒèˆ‡è€…!');
                        return;
                    }
                    
                    currentRoundData = validated;
                    currentRound++;
                    saveData();
                    updateStats();
                    
                    document.getElementById('uploadStatus').innerHTML = `
                        <div class="alert alert-success">
                            âœ… <strong>ç¬¬${currentRound}è¼ªåå–®ä¸Šå‚³æˆåŠŸ!</strong><br>
                            å…± ${validated.length} ä½å­¸ç”Ÿåƒèˆ‡æœ¬è¼ªå¾µé¸<br>
                            è«‹å‰å¾€ã€ŒğŸ° å¾µé¸æŠ½ç±¤ã€åˆ†é é€²è¡ŒæŠ½ç±¤
                        </div>
                    `;
                    
                    generateLotteryArea();
                    
                    setTimeout(() => {
                        document.querySelectorAll('.tab')[4].click();
                    }, 2000);
                    
                } catch(err) {
                    alert('âŒ æª”æ¡ˆè®€å–å¤±æ•—: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ========================================
        // ç”ŸæˆæŠ½ç±¤å€åŸŸ
        // ========================================
        function generateLotteryArea() {
            const area = document.getElementById('lotteryArea');
            
            if(currentRoundData.length === 0) {
                area.innerHTML = '<div class="alert alert-warning">âš ï¸ å°šæœªä¸Šå‚³æœ¬è¼ªåå–®<br>è«‹å…ˆåˆ°ã€ŒğŸ“¤ ä¸Šå‚³åå–®ã€åˆ†é ä¸Šå‚³Excelæª”æ¡ˆ</div>';
                return;
            }
            
            const byJob = {};
            currentRoundData.forEach(item => {
                if(!byJob[item.job]) byJob[item.job] = [];
                byJob[item.job].push(item);
            });
            
            let html = '';
            Object.keys(byJob).forEach(jobName => {
                const participants = byJob[jobName];
                const job = jobs.find(j => j.name === jobName);
                if(!job) return;
                
                const needed = job.count;
                const alreadyAssigned = allResults.filter(r => r.job === jobName && r.status === 'selected').length;
                const remaining = needed - alreadyAssigned;
                
                if(remaining <= 0) {
                    return;
                }
                
                const totalWeight = participants.reduce((sum, p) => sum + p.weight, 0);
                
                html += `
                    <div class="lottery-section" id="lottery-${jobName}">
                        <div class="lottery-title">ğŸ§¹ ${jobName}</div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                            <div>
                                éœ€è¦: ${needed} äºº | 
                                å·²åˆ†é…: ${alreadyAssigned} äºº | 
                                <span style="color:#c41e3a;font-weight:bold;">æœ¬æ¬¡å¾µé¸: ${Math.min(remaining, participants.length)} äºº</span>
                            </div>
                            <button class="btn btn-success btn-large" onclick="startLottery('${jobName}')">
                                ğŸ° é–‹å§‹æŠ½ç±¤
                            </button>
                        </div>
                        
                        <div class="probability-explanation">
                            ğŸ“Š <strong>æ©Ÿç‡è¨ˆç®—èªªæ˜:</strong> ç¸½æ¬Šé‡ = ${totalWeight}<br>
                            å¯¦éš›ä¸­é¸æ©Ÿç‡ = å€‹äººæ¬Šé‡ Ã· ${totalWeight} Ã— 100%
                        </div>
                        
                        <div class="participant-list" id="participants-${jobName}">
                            ${participants.map(p => {
                                const probability = totalWeight > 0 ? ((p.weight / totalWeight) * 100).toFixed(2) : 0;
                                return `
                                    <div class="participant-item" data-name="${p.name}">
                                        <div>
                                            <div class="participant-name">${p.seat} ${p.name}</div>
                                            <div class="participant-resource">${p.resource} Ã— ${p.amount}</div>
                                        </div>
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <div class="participant-weight">æ¬Šé‡: ${p.weight}</div>
                                            <div class="participant-probability">${probability}%</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="lottery-result" id="result-${jobName}"></div>
                    </div>
                `;
            });
            
            if(html === '') {
                area.innerHTML = '<div class="alert alert-success">âœ… æœ¬è¼ªæ‰€æœ‰é …ç›®éƒ½å·²æ»¿é¡!</div>';
            } else {
                area.innerHTML = html;
            }
        }

        // ========================================
        // æ ¸å¿ƒåŠŸèƒ½: é–‹å§‹æŠ½ç±¤
        // ========================================
        function startLottery(jobName) {
            const job = jobs.find(j => j.name === jobName);
            if(!job) return;
            
            const needed = job.count;
            const alreadyAssigned = allResults.filter(r => r.job === jobName && r.status === 'selected').length;
            const toSelect = needed - alreadyAssigned;
            
            const participants = currentRoundData.filter(p => p.job === jobName);
            
            if(participants.length === 0) return;
            
            event.target.disabled = true;
            event.target.textContent = 'æŠ½ç±¤ä¸­...';
            
            setTimeout(() => {
                const result = weightedRandomSelection(participants, toSelect);
                const winners = result.winners;
                const losers = result.losers;
                
                winners.forEach(w => {
                    selectedStudents.add(w.name);
                    allResults.push({
                        round: currentRound,
                        job: jobName,
                        seat: w.seat,
                        name: w.name,
                        resource: w.resource,
                        amount: w.amount,
                        weight: w.weight,
                        status: 'selected'
                    });
                });
                
                losers.forEach(l => {
                    allResults.push({
                        round: currentRound,
                        job: jobName,
                        seat: l.seat,
                        name: l.name,
                        resource: l.resource,
                        amount: l.amount,
                        weight: l.weight,
                        status: 'rejected'
                    });
                });
                
                saveData();
                
                winners.forEach(w => {
                    const item = document.querySelector(`#participants-${jobName} .participant-item[data-name="${w.name}"]`);
                    if(item) item.classList.add('selected');
                });
                
                losers.forEach(l => {
                    const item = document.querySelector(`#participants-${jobName} .participant-item[data-name="${l.name}"]`);
                    if(item) item.classList.add('rejected');
                });
                
                const resultDiv = document.getElementById(`result-${jobName}`);
                resultDiv.innerHTML = `
                    ğŸ‰ æŠ½ç±¤å®Œæˆ!<br>
                    ä¸­é¸ ${winners.length} äºº: ${winners.map(w => w.name).join(', ')}
                `;
                resultDiv.classList.add('show');
                
                createConfetti();
                
                updateStats();
                updateResults();
                
                event.target.textContent = 'âœ… æŠ½ç±¤å®Œæˆ';
                
            }, 1500);
        }

        // ========================================
        // ç‘èŠ±ç‰¹æ•ˆ
        // ========================================
        function createConfetti() {
            const colors = ['#f0f', '#0ff', '#ff0', '#0f0', '#f00', '#00f'];
            for(let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-10px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // ========================================
        // çµ±è¨ˆæ›´æ–°
        // ========================================
        function updateStats() {
            document.getElementById('currentRound').textContent = currentRound;
            document.getElementById('nextRound').textContent = currentRound + 1;
            document.getElementById('assignedCount').textContent = selectedStudents.size;
            document.getElementById('thisRoundCount').textContent = currentRoundData.length;
        }

        // ========================================
        // çµæœé¡¯ç¤ºèˆ‡éš¨æ©Ÿåˆ†é…
        // ========================================
        function updateResults() {
            const summary = document.getElementById('resultSummary');
            const content = document.getElementById('resultContent');
            const randomArea = document.getElementById('randomAssignArea');
            
            if(allResults.length === 0) {
                summary.innerHTML = '<div class="alert alert-warning">å°šæœªé€²è¡Œä»»ä½•å¾µé¸</div>';
                content.innerHTML = '';
                randomArea.innerHTML = '';
                return;
            }
            
            const selected = allResults.filter(r => r.status === 'selected').length;
            const rejected = allResults.filter(r => r.status === 'rejected').length;
            
            summary.innerHTML = `
                <div class="alert alert-success">
                    ğŸ“Š å¾µé¸é€²åº¦<br>
                    å·²å®Œæˆè¼ªæ¬¡: ${currentRound} è¼ª | 
                    ä¸­é¸: ${selected} äºº | 
                    æœªä¸­é¸: ${rejected} äºº
                </div>
            `;
            
            const totalNeeded = jobs.reduce((sum, j) => sum + j.count, 0);
            const currentAssigned = allResults.filter(r => r.status === 'selected').length;
            const remaining = totalNeeded - currentAssigned;
            
            if(remaining > 0 && students.length > 0) {
                const unassignedStudents = students.filter(s => !selectedStudents.has(s.name));
                
                randomArea.innerHTML = `
                    <div class="section">
                        <h3>ğŸ² éš¨æ©Ÿåˆ†é…å‰©é¤˜è·ç¼º</h3>
                        <div class="alert alert-info">
                            ğŸ“Š çµ±è¨ˆ:<br>
                            â€¢ å‰©é¤˜è·ç¼º: ${remaining} å€‹<br>
                            â€¢ æœªåˆ†é…å­¸ç”Ÿ: ${unassignedStudents.length} äºº<br>
                            â€¢ ç­ç´šç¸½äººæ•¸: ${students.length} äºº
                        </div>
                        ${remaining > 0 && unassignedStudents.length > 0 ? `
                            <button class="btn btn-success btn-large" onclick="performRandomAssign()">
                                ğŸ² åŸ·è¡Œéš¨æ©Ÿåˆ†é…
                            </button>
                        ` : `
                            <div class="alert alert-success">âœ… æ‰€æœ‰è·ç¼ºå·²åˆ†é…å®Œæˆ!</div>
                        `}
                    </div>
                `;
            } else {
                randomArea.innerHTML = '';
            }
            
            const byRound = {};
            allResults.forEach(r => {
                if(!byRound[r.round]) byRound[r.round] = {};
                if(!byRound[r.round][r.job]) byRound[r.round][r.job] = [];
                byRound[r.round][r.job].push(r);
            });
            
            let html = '';
            Object.keys(byRound).sort((a,b) => a - b).forEach(round => {
                html += `<div class="section"><h3>ç¬¬ ${round} è¼ªçµæœ</h3>`;
                
                Object.keys(byRound[round]).forEach(jobName => {
                    const list = byRound[round][jobName];
                    const totalWeight = list.reduce((sum, r) => sum + (typeof r.weight === 'number' ? r.weight : 0), 0);
                    
                    html += `
                        <div style="margin:15px 0;">
                            <h4 style="color:#333;margin-bottom:10px;">ğŸ§¹ ${jobName}</h4>
                            <div style="background:#fff3cd;padding:8px;border-radius:6px;margin-bottom:10px;font-size:0.9em;">
                                ç¸½æ¬Šé‡: ${totalWeight} | å¯¦éš›æ©Ÿç‡ = å€‹äººæ¬Šé‡ Ã· ${totalWeight} Ã— 100%
                            </div>
                            <table class="result-table">
                                <tr>
                                    <th>åº§è™Ÿ</th>
                                    <th>å§“å</th>
                                    <th>æŠ•å…¥è³‡æº</th>
                                    <th>æ•¸é‡</th>
                                    <th>æ¬Šé‡</th>
                                    <th>å¯¦éš›æ©Ÿç‡</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                                ${list.map(r => {
                                    const probability = totalWeight > 0 && typeof r.weight === 'number' ? ((r.weight / totalWeight) * 100).toFixed(2) : '-';
                                    return `
                                        <tr>
                                            <td>${r.seat}</td>
                                            <td><strong>${r.name}</strong></td>
                                            <td>${r.resource}</td>
                                            <td>${r.amount}</td>
                                            <td>${r.weight}</td>
                                            <td><strong>${probability === '-' ? '-' : probability + '%'}</strong></td>
                                            <td>
                                                <span class="status-badge ${r.status === 'selected' ? 'status-selected' : 'status-rejected'}">
                                                    ${r.status === 'selected' ? 'âœ… ä¸­é¸' : 'âŒ æœªä¸­é¸'}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </table>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            content.innerHTML = html;
        }

        // ========================================
        // éš¨æ©Ÿåˆ†é…
        // ========================================
        function performRandomAssign() {
            if(students.length === 0) {
                alert('âŒ è«‹å…ˆä¸Šå‚³ç­ç´šåå–®!');
                return;
            }
            
            const unassignedStudents = students.filter(s => !selectedStudents.has(s.name));
            
            if(unassignedStudents.length === 0) {
                alert('âœ… æ‰€æœ‰å­¸ç”Ÿéƒ½å·²åˆ†é…!');
                return;
            }
            
            let count = 0;
            jobs.forEach(job => {
                const current = allResults.filter(r => r.job === job.name && r.status === 'selected').length;
                const needed = job.count - current;
                
                for(let i = 0; i < needed && unassignedStudents.length > 0; i++) {
                    const idx = Math.floor(Math.random() * unassignedStudents.length);
                    const student = unassignedStudents.splice(idx, 1)[0];
                    
                    selectedStudents.add(student.name);
                    allResults.push({
                        round: 'éš¨æ©Ÿ',
                        job: job.name,
                        seat: student.seat,
                        name: student.name,
                        resource: '-',
                        amount: '-',
                        weight: '-',
                        status: 'selected'
                    });
                    count++;
                }
            });
            
            if(count > 0) {
                saveData();
                updateResults();
                alert(`âœ… éš¨æ©Ÿåˆ†é…å®Œæˆ! å…±åˆ†é… ${count} å€‹è·ç¼º`);
            } else {
                alert('âœ… æ²’æœ‰å‰©é¤˜è·ç¼ºéœ€è¦åˆ†é…!');
            }
        }

        // ========================================
        // åŒ¯å‡ºçµæœ (ä¾æ‰“æƒé …ç›®)
        // ========================================
        function exportByJob() {
            if(allResults.length === 0) {
                alert('âŒ å°šç„¡çµæœå¯åŒ¯å‡º!');
                return;
            }
            
            // åªåŒ¯å‡ºä¸­é¸è€…,æŒ‰æ‰“æƒé …ç›®åˆ†é¡
            const data = [['ä¸­ç±¤æ‰“æƒé …ç›®', 'åº§è™Ÿ', 'å§“å']];
            
            const selectedResults = allResults.filter(r => r.status === 'selected');
            
            // æŒ‰æ‰“æƒé …ç›®åˆ†çµ„
            const byJob = {};
            selectedResults.forEach(r => {
                if(!byJob[r.job]) byJob[r.job] = [];
                byJob[r.job].push(r);
            });
            
            // ä¾ç…§é è¨­é …ç›®é †åºæ’åˆ—
            jobs.forEach(job => {
                if(byJob[job.name]) {
                    byJob[job.name].forEach(r => {
                        data.push([r.job, r.seat, r.name]);
                    });
                }
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:30},{wch:10},{wch:15}];
            XLSX.utils.book_append_sheet(wb, ws, 'ä¾æ‰“æƒé …ç›®');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `æ‰“æƒå¾µæ‰çµæœ_ä¾é …ç›®_${date}.xlsx`);
        }

        // ========================================
        // åŒ¯å‡ºçµæœ (ä¾å­¸ç”Ÿçµ±è¨ˆ)
        // ========================================
        function exportByStudent() {
            if(allResults.length === 0) {
                alert('âŒ å°šç„¡çµæœå¯åŒ¯å‡º!');
                return;
            }
            
            // çµ±è¨ˆæ¯ä½å­¸ç”Ÿçš„æ‰€æœ‰åƒèˆ‡è¨˜éŒ„
            const data = [['åº§è™Ÿ', 'å§“å', 'å¾µé¸è¼ªæ¬¡', 'æŠ•å…¥è³‡æºç¨®é¡', 'æŠ•å…¥è³‡æºæ•¸é‡', 'ä¸­ç±¤èˆ‡å¦']];
            
            // æŒ‰å­¸ç”Ÿåˆ†çµ„
            const byStudent = {};
            allResults.forEach(r => {
                const key = r.name;
                if(!byStudent[key]) byStudent[key] = [];
                byStudent[key].push(r);
            });
            
            // æŒ‰åº§è™Ÿæ’åº
            const sortedStudents = Object.keys(byStudent).sort((a, b) => {
                const seatA = byStudent[a][0].seat;
                const seatB = byStudent[b][0].seat;
                return seatA - seatB;
            });
            
            sortedStudents.forEach(studentName => {
                const records = byStudent[studentName];
                records.forEach(r => {
                    data.push([
                        r.seat,
                        r.name,
                        r.round === 'éš¨æ©Ÿ' ? 'éš¨æ©Ÿåˆ†é…' : `ç¬¬${r.round}è¼ª`,
                        r.resource,
                        r.amount,
                        r.status === 'selected' ? 'ä¸­ç±¤' : 'æœªä¸­ç±¤'
                    ]);
                });
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:10},{wch:15},{wch:15},{wch:18},{wch:18},{wch:12}];
            XLSX.utils.book_append_sheet(wb, ws, 'ä¾å­¸ç”Ÿçµ±è¨ˆ');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `æ‰“æƒå¾µæ‰çµæœ_ä¾å­¸ç”Ÿ_${date}.xlsx`);
        }

        // ========================================
        // ä¸‹è¼‰ç¯„ä¾‹
        // ========================================
        function downloadTemplate() {
            const data = [
                ['åº§è™Ÿ', 'å§“å', 'åƒèˆ‡æ‰“æƒé …ç›®', 'æŠ•å…¥è³‡æºç¨®é¡', 'è³‡æºæŠ•å…¥æ•¸é‡', 'å¾µé¸è¼ªæ¬¡'],
                [1, 'å°æ˜', '[æ•™å®¤]åœ°æ¿å¤©èŠ±æ¿', 'é‡‘å¹£', 150, 'ç¬¬1è¼ª'],
                [2, 'å°è¯', '[æ•™å®¤]æ“¦é–€çª—', 'è€å¸«ç°½åå¡', 2, 'ç¬¬1è¼ª'],
                [3, 'å°ç¾', '[æ•™å®¤]å€’åƒåœ¾(å«é™½å°åœ°æ¿)', 'æœ€å¼·ç‹ç‰Œ', 1, 'ç¬¬1è¼ª'],
                [4, 'å°å¼·', '[æ•™å®¤]é»‘æ¿æ•™å¸«æ¡Œ', 'é‡‘å¹£', 90, 'ç¬¬1è¼ª'],
                [6, 'å°å‚‘', '[æ•™å®¤]æ›¸æ«ƒé›»è…¦æ«ƒåœ–æ›¸æ«ƒ', 'é‡‘å¹£', 60, 'ç¬¬2è¼ª'],
                [7, 'å°ç²', '[æ•™å®¤]æ´—æ‰‹å°é£²æ°´æ©Ÿ', 'è€å¸«ç°½åå¡', 1, 'ç¬¬2è¼ª']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:8},{wch:12},{wch:30},{wch:18},{wch:18},{wch:12}];
            XLSX.utils.book_append_sheet(wb, ws, 'å¾µé¸åå–®');
            XLSX.writeFile(wb, 'æ‰“æƒå¾µé¸ç¯„ä¾‹.xlsx');
        }

        // ========================================
        // é‡ç½®
        // ========================================
        function resetAll() {
            if(confirm('âš ï¸ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—?\n\né€™å°‡æ¸…é™¤æ‰€æœ‰å¾µé¸è¨˜éŒ„,ä½†ä¿ç•™è³‡æºã€é …ç›®å’Œç­ç´šåå–®ã€‚')) {
                currentRoundData = [];
                allResults = [];
                selectedStudents.clear();
                currentRound = 0;
                saveData();
                updateAll();
                document.getElementById('uploadStatus').innerHTML = '';
                alert('âœ… å·²é‡ç½®!å¯ä»¥é–‹å§‹æ–°çš„å¾µé¸ã€‚');
            }
        }
    </script>
</body>
</html>
