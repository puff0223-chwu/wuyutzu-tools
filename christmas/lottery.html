<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•ç¯€äº¤æ›ç¦®ç‰©æŠ½ç±¤ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #c41e3a;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #2c5f2d;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c5f2d;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 150px;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        button {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(196, 30, 58, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result-box {
            background: #f0f8ff;
            border: 3px solid #2c5f2d;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .result-box.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gift-to {
            font-size: 1.8em;
            color: #c41e3a;
            font-weight: bold;
            margin: 15px 0;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .success {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: #155724;
            display: none;
        }

        .success.show {
            display: block;
        }

        .step-indicator {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .step {
            text-align: center;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .step.active .step-number {
            background: #c41e3a;
        }

        .step-label {
            font-size: 0.85em;
            color: #666;
        }

        .snowflake {
            position: fixed;
            top: -10px;
            z-index: 9999;
            user-select: none;
            cursor: default;
            animation: snowfall linear infinite;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" style="display: inline-block; color: #667eea; text-decoration: none; font-size: 1.1em; margin-bottom: 20px; transition: color 0.3s;" onmouseover="this.style.color='#c41e3a'" onmouseout="this.style.color='#667eea'">
            â† è¿”å›é¦–é 
        </a>
        <h1>ğŸ„ è–èª•ç¯€äº¤æ›ç¦®ç‰©æŠ½ç±¤ç³»çµ±</h1>
        <p class="subtitle">è®“æ¯å€‹äººéƒ½ä¿æœ‰ç¥ç§˜æ„Ÿçš„æŠ½ç±¤å·¥å…·</p>

        <div class="step-indicator">
            <div class="step active" id="step1-indicator">
                <div class="step-number">1</div>
                <div class="step-label">è¨­å®šåå–®</div>
            </div>
            <div class="step" id="step2-indicator">
                <div class="step-number">2</div>
                <div class="step-label">æŸ¥è©¢å°è±¡</div>
            </div>
        </div>

        <!-- æ­¥é©Ÿä¸€: è¨­å®šåå–® -->
        <div id="step1" class="section">
            <div class="section-title">ğŸ“ æ­¥é©Ÿä¸€:è¨­å®šåƒèˆ‡è€…åå–®</div>
            
            <div class="warning">
                âš ï¸ <strong>é‡è¦æé†’:</strong> è¨­å®šå®Œæˆå¾Œ,è«‹åœ¨æ´»å‹•ç•¶å¤©æ‰è®“å¤§å®¶æŸ¥è©¢,ç¢ºä¿é…å°çµæœä¿å¯†!
            </div>

            <!-- ä¸Šå‚³å‚™ä»½æª”æ¡ˆå€å¡Š -->
            <div style="background: #e3f2fd; border: 2px dashed #2196f3; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h4 style="color: #1976d2; margin-bottom: 12px; font-size: 1.1em;">ğŸ“‚ å·²æœ‰å‚™ä»½æª”æ¡ˆ?ç›´æ¥ä¸Šå‚³</h4>
                <p style="color: #555; margin-bottom: 15px; font-size: 0.9em;">
                    å¦‚æœä½ ä¹‹å‰å·²ç¶“ä¸‹è¼‰éé…å°æ¸…å–®,å¯ä»¥ç›´æ¥ä¸Šå‚³æª”æ¡ˆ,ç³»çµ±æœƒè‡ªå‹•è¼‰å…¥é…å°è³‡æ–™ã€‚<br>
                    é€™æ¨£è€å¸«å°±ä¸ç”¨çœ‹åˆ°é…å°å…§å®¹,ä¿æŒç¥ç§˜æ„Ÿ!
                </p>
                <input type="file" id="backupFile" accept=".txt" style="display: none;" onchange="loadBackupFile()">
                <button onclick="document.getElementById('backupFile').click()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">
                    ğŸ“¤ ä¸Šå‚³å‚™ä»½æ¸…å–®
                </button>
                <div id="uploadStatus" style="margin-top: 10px; display: none;"></div>
            </div>

            <div style="text-align: center; margin: 20px 0; color: #999; font-weight: bold;">
                â”€â”€â”€ æˆ– â”€â”€â”€
            </div>

            <div class="input-group">
                <label>åƒèˆ‡è€…åå–® (æ¯è¡Œä¸€å€‹åå­—)</label>
                <textarea id="nameList" placeholder="ä¾‹å¦‚:&#10;å·«è€å¸«&#10;å°æ˜&#10;å°è¯&#10;å°ç¾&#10;å°å¼·"></textarea>
                <div class="help-text">ğŸ’¡ è«‹è¼¸å…¥æ‰€æœ‰åƒèˆ‡è€…çš„åå­—,åŒ…æ‹¬æ‚¨è‡ªå·±</div>
            </div>

            <button onclick="generatePairs()">ğŸ² é–‹å§‹é…å°(è¨˜å¾—ä¿å¯†çµæœ!)</button>

            <div id="setupSuccess" class="success">
                <div style="font-size: 1.1em; margin-bottom: 15px;">
                    âœ… <strong>é…å°å®Œæˆ!</strong> 
                </div>
                <div style="margin-bottom: 15px; color: #155724;">
                    è«‹è€å¸«å…ˆä¸‹è¼‰é…å°æ¸…å–®å‚™ç”¨,ç„¶å¾Œå†é–‹å§‹è®“å­¸ç”ŸæŸ¥è©¢
                </div>
                <button onclick="downloadPairList()" style="margin-top: 10px; background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%);">
                    ğŸ“¥ ä¸‹è¼‰é…å°æ¸…å–®(è€å¸«å‚™ç”¨)
                </button>
                <button onclick="goToQueryStep()" style="margin-top: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    â¡ï¸ é–‹å§‹è®“å­¸ç”ŸæŸ¥è©¢
                </button>
            </div>
        </div>

        <!-- æ­¥é©ŸäºŒ: æŸ¥è©¢é€ç¦®å°è±¡ -->
        <div id="step2" class="section hidden">
            <div class="section-title">ğŸ” æ­¥é©ŸäºŒ:æŸ¥è©¢ä½ çš„é€ç¦®å°è±¡</div>

            <!-- ä¸Šå‚³é…å°æª”æ¡ˆå€åŸŸ -->
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">
                    ğŸ“¤ è€å¸«å°ˆç”¨:ä¸Šå‚³ä¹‹å‰ä¸‹è¼‰çš„é…å°æª”æ¡ˆ
                </div>
                <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">
                    å¦‚æœé—œæ‰ç¶²é å¾Œéœ€è¦é‡æ–°æŸ¥è©¢,è€å¸«å¯ä»¥ä¸Šå‚³ä¹‹å‰ä¸‹è¼‰çš„ .txt é…å°æª”æ¡ˆ,è®“åŒå­¸ç¹¼çºŒæŸ¥è©¢
                </div>
                <input type="file" id="uploadPairFile" accept=".txt" style="margin-bottom: 10px;">
                <button onclick="loadPairFile()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 10px 20px; font-size: 0.9em;">
                    ğŸ“‚ è¼‰å…¥é…å°æª”æ¡ˆ
                </button>
                <div id="uploadStatus" style="margin-top: 10px; font-size: 0.9em; color: #16a34a;"></div>
            </div>

            <div class="input-group">
                <label>è«‹è¼¸å…¥ä½ çš„åå­—</label>
                <input type="text" id="queryName" placeholder="è¼¸å…¥ä½ åœ¨åå–®ä¸­çš„åå­—">
                <div class="help-text">ğŸ’¡ æ¯å€‹äººè¼¸å…¥è‡ªå·±çš„åå­—å³å¯æŸ¥è©¢</div>
            </div>

            <button onclick="queryGiftTarget()">ğŸ æŸ¥è©¢æˆ‘è¦é€ç¦®çµ¦èª°</button>

            <div id="resultBox" class="result-box">
                <div style="font-size: 1.2em; color: #2c5f2d;">ğŸ… ä½ è¦é€ç¦®ç‰©çµ¦:</div>
                <div class="gift-to" id="giftTarget"></div>
                <div style="margin-top: 15px; color: #666;">è¨˜å¾—ä¿å¯†,ä¸è¦å‘Šè¨´åˆ¥äººå–”! ğŸ¤«</div>
            </div>
        </div>
    </div>

    <script>
        let pairs = {};
        let participants = [];

        function generatePairs() {
            const nameListText = document.getElementById('nameList').value.trim();
            
            if (!nameListText) {
                alert('è«‹å…ˆè¼¸å…¥åƒèˆ‡è€…åå–®!');
                return;
            }

            // è§£æåå–®
            participants = nameListText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);

            if (participants.length < 2) {
                alert('è‡³å°‘éœ€è¦2å€‹åƒèˆ‡è€…æ‰èƒ½é€²è¡Œäº¤æ›ç¦®ç‰©!');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡åå­—
            const uniqueNames = new Set(participants);
            if (uniqueNames.size !== participants.length) {
                alert('åå–®ä¸­æœ‰é‡è¤‡çš„åå­—,è«‹ä¿®æ”¹å¾Œå†è©¦!');
                return;
            }

            // ç”Ÿæˆé…å°(ç¢ºä¿æ²’äººæŠ½åˆ°è‡ªå·±)
            pairs = generateDerangement(participants);

            if (!pairs) {
                alert('é…å°ç”Ÿæˆå¤±æ•—,è«‹é‡è©¦!');
                return;
            }

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            document.getElementById('setupSuccess').classList.add('show');

            // æ·»åŠ é›ªèŠ±æ•ˆæœ
            createSnowflakes();
        }

        function generateDerangement(arr) {
            // ç”Ÿæˆä¸€å€‹æ’åˆ—,ç¢ºä¿æ²’æœ‰å…ƒç´ åœ¨åŸä½ç½®(æ²’äººæŠ½åˆ°è‡ªå·±)
            const n = arr.length;
            let attempts = 0;
            const maxAttempts = 1000;

            while (attempts < maxAttempts) {
                let shuffled = [...arr];
                
                // Fisher-Yates æ´—ç‰Œæ¼”ç®—æ³•
                for (let i = n - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }

                // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„éŒ¯æ’(æ²’äººæŠ½åˆ°è‡ªå·±)
                let valid = true;
                for (let i = 0; i < n; i++) {
                    if (arr[i] === shuffled[i]) {
                        valid = false;
                        break;
                    }
                }

                if (valid) {
                    // å»ºç«‹é…å°æ˜ å°„
                    let result = {};
                    for (let i = 0; i < n; i++) {
                        result[arr[i]] = shuffled[i];
                    }
                    return result;
                }

                attempts++;
            }

            return null;
        }

        function queryGiftTarget() {
            const queryName = document.getElementById('queryName').value.trim();

            if (!queryName) {
                alert('è«‹è¼¸å…¥ä½ çš„åå­—!');
                return;
            }

            if (!participants.includes(queryName)) {
                alert('æ‰¾ä¸åˆ°é€™å€‹åå­—,è«‹ç¢ºèªåå­—æ˜¯å¦æ­£ç¢º!');
                return;
            }

            const target = pairs[queryName];
            document.getElementById('giftTarget').textContent = target;
            document.getElementById('resultBox').classList.add('show');

            // 3ç§’å¾Œè‡ªå‹•æ¸…ç©ºè¼¸å…¥æ¡†å’Œçµæœ
            setTimeout(() => {
                document.getElementById('queryName').value = '';
                document.getElementById('resultBox').classList.remove('show');
            }, 3000);
        }

        function downloadPairList() {
            // ç”Ÿæˆé…å°æ¸…å–®æ–‡å­—å…§å®¹(çµ¦è€å¸«çœ‹çš„)
            let content = 'ğŸ„ è–èª•ç¯€äº¤æ›ç¦®ç‰©é…å°æ¸…å–® ğŸ\n';
            content += '=' .repeat(40) + '\n';
            content += 'ç”Ÿæˆæ™‚é–“: ' + new Date().toLocaleString('zh-TW') + '\n';
            content += '=' .repeat(40) + '\n\n';
            
            // æŒ‰ç…§åŸå§‹åå–®é †åºè¼¸å‡º
            participants.forEach((person, index) => {
                content += `${index + 1}. ${person} â†’ ${pairs[person]}\n`;
            });
            
            content += '\n' + '=' .repeat(40) + '\n';
            content += 'âš ï¸ æ­¤æ¸…å–®åƒ…ä¾›è€å¸«å‚™ç”¨,è«‹å¦¥å–„ä¿ç®¡!\n';
            content += 'å»ºè­°ç”¨é€”: ç•¶å­¸ç”Ÿå¿˜è¨˜æˆ–å‡ºåŒ…æ™‚çš„ç·Šæ€¥æŸ¥è©¢\n';
            content += '\n';
            content += 'ğŸ’¡ æç¤º: æ­¤æª”æ¡ˆå¯ä»¥é‡æ–°ä¸Šå‚³åˆ°ç³»çµ±,è®“åŒå­¸æŸ¥è©¢!\n';
            content += '\n' + '=' .repeat(40) + '\n';
            content += 'ğŸ“Š é…å°è³‡æ–™ (ç³»çµ±ç”¨,è«‹å‹¿ä¿®æ”¹)\n';
            content += '=' .repeat(40) + '\n';
            
            // åŠ å…¥å¯é‡æ–°è¼‰å…¥çš„è³‡æ–™
            const reloadData = {
                participants: participants,
                pairs: pairs,
                timestamp: new Date().toISOString()
            };
            content += JSON.stringify(reloadData);

            // å‰µå»ºä¸‹è¼‰
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è–èª•äº¤æ›ç¦®ç‰©é…å°æ¸…å–®_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('âœ… é…å°æ¸…å–®å·²ä¸‹è¼‰!\næ­¤æª”æ¡ˆå¯ä»¥é‡æ–°ä¸Šå‚³åˆ°ç³»çµ±,è®“å¿˜è¨˜çš„åŒå­¸æŸ¥è©¢ã€‚');
        }

        function goToQueryStep() {
            // åˆ‡æ›åˆ°æ­¥é©ŸäºŒ:æŸ¥è©¢éšæ®µ
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('step1-indicator').classList.remove('active');
            document.getElementById('step2-indicator').classList.add('active');
        }

        function loadBackupFile() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ!');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let loadedParticipants = [];
                    let loadedPairs = {};
                    
                    // æ–¹æ³•1: å˜—è©¦è®€å–æ–°æ ¼å¼(åŒ…å«JSONè³‡æ–™)
                    const jsonMatch = content.match(/\{[\s\S]*"participants"[\s\S]*"pairs"[\s\S]*\}/);
                    
                    if (jsonMatch) {
                        // æ–°æ ¼å¼: ç›´æ¥è§£æJSON
                        const data = JSON.parse(jsonMatch[0]);
                        
                        if (!data.participants || !data.pairs) {
                            throw new Error('é…å°è³‡æ–™ä¸å®Œæ•´');
                        }
                        
                        loadedParticipants = data.participants;
                        loadedPairs = data.pairs;
                        
                    } else {
                        // æ–¹æ³•2: è§£æèˆŠæ ¼å¼(å¾é…å°æ¸…å–®ä¸­æå–)
                        const lines = content.split('\n');
                        const pairPattern = /^\d+\.\s+(.+?)\s+â†’\s+(.+?)$/;
                        
                        for (let line of lines) {
                            line = line.trim();
                            const match = line.match(pairPattern);
                            
                            if (match) {
                                const giver = match[1].trim();
                                const receiver = match[2].trim();
                                
                                // åŠ å…¥åƒèˆ‡è€…åˆ—è¡¨
                                if (!loadedParticipants.includes(giver)) {
                                    loadedParticipants.push(giver);
                                }
                                if (!loadedParticipants.includes(receiver)) {
                                    loadedParticipants.push(receiver);
                                }
                                
                                // å»ºç«‹é…å°é—œä¿‚
                                loadedPairs[giver] = receiver;
                            }
                        }
                        
                        if (loadedParticipants.length === 0) {
                            throw new Error('ç„¡æ³•å¾æª”æ¡ˆä¸­è®€å–é…å°è³‡æ–™');
                        }
                    }
                    
                    // è¼‰å…¥è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸
                    participants = loadedParticipants;
                    pairs = loadedPairs;
                    
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    const uploadStatus = document.getElementById('uploadStatus');
                    uploadStatus.innerHTML = `âœ… <strong>æˆåŠŸè¼‰å…¥é…å°æª”æ¡ˆ!</strong><br>å…± ${participants.length} ä½åƒèˆ‡è€…,å¯ä»¥é–‹å§‹æŸ¥è©¢äº†!`;
                    uploadStatus.style.display = 'block';
                    uploadStatus.style.color = '#16a34a';
                    uploadStatus.style.padding = '12px';
                    uploadStatus.style.background = '#d4edda';
                    uploadStatus.style.borderRadius = '8px';
                    uploadStatus.style.marginTop = '10px';
                    
                    // è‡ªå‹•åˆ‡æ›åˆ°æŸ¥è©¢æ­¥é©Ÿ
                    setTimeout(() => {
                        goToQueryStep();
                    }, 1500);
                    
                } catch (error) {
                    alert('âŒ æª”æ¡ˆè®€å–å¤±æ•—!\nè«‹ç¢ºèªä¸Šå‚³çš„æ˜¯ç³»çµ±ä¸‹è¼‰çš„é…å°æª”æ¡ˆã€‚\néŒ¯èª¤: ' + error.message);
                    const uploadStatus = document.getElementById('uploadStatus');
                    uploadStatus.innerHTML = 'âŒ è¼‰å…¥å¤±æ•—,è«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼';
                    uploadStatus.style.display = 'block';
                    uploadStatus.style.color = '#dc2626';
                    uploadStatus.style.padding = '12px';
                    uploadStatus.style.background = '#fee';
                    uploadStatus.style.borderRadius = '8px';
                }
            };
            
            reader.onerror = function() {
                alert('âŒ æª”æ¡ˆè®€å–éŒ¯èª¤!');
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function createSnowflakes() {
            const snowflakes = ['â„ï¸', 'â…', 'â†'];
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const snowflake = document.createElement('div');
                    snowflake.className = 'snowflake';
                    snowflake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
                    snowflake.style.left = Math.random() * 100 + '%';
                    snowflake.style.animationDuration = (Math.random() * 3 + 5) + 's';
                    snowflake.style.opacity = Math.random();
                    snowflake.style.fontSize = (Math.random() * 10 + 20) + 'px';
                    document.body.appendChild(snowflake);

                    setTimeout(() => {
                        snowflake.remove();
                    }, 8000);
                }, i * 300);
            }
        }
    </script>
</body>
</html>